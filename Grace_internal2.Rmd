---
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readxl)
library(httr)
library(scales)
library(zoo)
library(data.table)
library(usmap)
library(readxl)
library(gt)
library(lubridate)

#Load Student and Employee Data
load("S.Rdata")
load("E.Rdata")

#Kosciusko Data
url = "https://hub.mph.in.gov/dataset/bd08cdd3-9ab1-4d70-b933-41f9ef7b809d/resource/afaa225d-ac4e-4e80-9190-f6800c366b58/download/covid_report_county_date.xlsx"
GET(url, write_disk(tf <- tempfile(fileext = ".xlsx")))
IN_counties <- read_excel(tf)
K <- subset(IN_counties, IN_counties$COUNTY_NAME == "Kosciusko")
K$DATE <- as.Date(K$DATE)

url3 = "https://hub.mph.in.gov/dataset/07e12c46-eb38-43cf-b9e1-46a9c305beaa/resource/9ae4b185-b81d-40d5-aee2-f0e30405c162/download/covid_report_demographics_county_district.xlsx"
GET(url3, write_disk(tf <- tempfile(fileext = ".xlsx")))
df <- read_excel(tf)
K2 <- subset(df, df$county_name == "Kosciusko")
K$DATE <- as.Date(K$DATE)

#Indiana Data
url2 = "https://hub.mph.in.gov/dataset/ab9d97ab-84e3-4c19-97f8-af045ee51882/resource/182b6742-edac-442d-8eeb-62f96b17773e/download/covid_report_date.xlsx"
GET(url2, write_disk(tf <- tempfile(fileext = ".xlsx")))
I <- read_excel(tf)
I$DATE <- as.Date(I$DATE)

#The first day of data
fall <- as.Date("2020-07-20")
spring <- as.Date("2021-01-01")
yest <- Sys.Date()-1
last <- as.Date("2021-05-14")


S_all <- S %>%
  #Determine Home or Grace
  mutate(Location2 = factor(case_when(
    tolower(substring(Location, 1, 4)) == "home" ~ "Home",
    tolower(substring(Location, 1, 4)) == "off " ~ "Home",
    tolower(substring(Location, 1, 4)) == "fami" ~ "Home",
    TRUE ~ "Grace"),
    levels = c("Home", "Grace"))) %>%
  #Fix different ways of entering positives and negatives
  mutate(Test_Result = tolower(substring(S$Test_Result, 1, 1))) %>%
  #Fix positives that are not marked as isolated yet
  mutate(Isolated = case_when(
    Test_Result == "p" & is.na(Isolated) & !is.na(Quarantine) ~ Quarantine,
    TRUE ~ Isolated
  ))%>%
  #Filter only spring cases
  filter(pmax(Quarantine, Isolated, TQS, na.rm = TRUE) > fall,
         pmin(Quarantine, Isolated, TQS, na.rm = TRUE) <= yest) %>%
  #Mark TQS as quarantine
  mutate(Q_type = factor(case_when(
    !is.na(TQS) ~ "travel",
    !is.na(Quarantine) ~ "exposure",
    TRUE ~ as.character(NA)
  ), levels = c("travel", "exposure")),
  Quarantine = pmax(TQS, Quarantine, na.rm = TRUE))%>%
  #Add end dates when missing
  mutate(End_Date = case_when(
    is.na(End_Date) & is.na(Ryan) ~ yest + 1,
    is.na(End_Date) ~ max(Quarantine, Isolated, Result_Date,
                          Test_Date, na.rm = TRUE) + 14,
    TRUE ~ End_Date
  ))

S_spring <- S_all %>%
  filter(pmax(Quarantine, Isolated, TQS, na.rm = TRUE) > spring)


E_all <- E %>%
  #Fix missing end dates for E if a return to work date exists
  mutate(End_Date = case_when(
    is.na(End_Date) & !is.na(Return_Date) ~ Return_Date,
    TRUE ~ End_Date
  )) %>%
  #Fix different ways of entering positives and negatives
  mutate(Test_Result = tolower(substring(E$Test_Result, 1, 1))) %>%
  #Don't count quarantines that are dated after isolation
  mutate(Quarantine = case_when(
    !is.na(Quarantine) & !is.na(Isolated) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine
  )) %>%
  mutate(End_Date = case_when(
    is.na(End_Date) ~ max(Quarantine, Isolated, Result_Date,
                          Test_Date, na.rm = TRUE) + 14,
    TRUE ~ End_Date
  ))

E_spring <- E_all %>%
  filter(pmax(Quarantine, Isolated, na.rm = TRUE) > spring)

##############################################################################
#Student Quarantine

#Fill in dates between start of student quarantine and end date
QS <- S_spring %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated > Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(ID:First_Name, Location2, Q_type, Quarantine, End_Date)

#Then total for each day
QS_by_day <- QS %>%
  rowwise() %>%
  do(data.frame(.[1:5], Quarantine = seq(.$Quarantine, .$End_Date, by = "1 day")))

QS_yest <- QS_by_day %>%
  group_by(Quarantine, Location2, Q_type, .drop = FALSE) %>%
  summarise(n = n()) %>%
  filter(Quarantine == yest) %>%
  pivot_wider(names_from = c(Q_type, Location2), values_from = n) %>%
  mutate(Total = travel_Grace + exposure_Grace + travel_Home + exposure_Home) %>%
  ungroup() %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Total, travel_Grace, exposure_Grace, exposure_Home)

QS_spring_total <- QS %>%
  group_by(Location2, Q_type, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = c(Q_type, Location2), values_from = n) %>%
  mutate(Total = travel_Grace + exposure_Grace + travel_Home + exposure_Home) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Total, travel_Grace, exposure_Grace, exposure_Home)

QS_all_total <- S_all %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated > Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(ID:First_Name, Location2, Q_type, Quarantine, End_Date) %>%
  group_by(Location2, Q_type, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = c(Q_type, Location2), values_from = n) %>%
  mutate(Total = travel_Grace + exposure_Grace + travel_Home + exposure_Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Total, travel_Grace, exposure_Grace, exposure_Home)

QS_all_unique <- S_all %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated > Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(ID:First_Name, Location2, Q_type, Quarantine, End_Date) %>%
  distinct(First_Name, Last_Name, Q_type, .keep_all = TRUE)%>%
  group_by(Location2, Q_type, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = c(Q_type, Location2), values_from = n) %>%
  mutate(Total = travel_Grace + exposure_Grace + travel_Home + exposure_Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Unique Students") %>%
  select(Type, Total, travel_Grace, exposure_Grace, exposure_Home)

QS_Tab <- bind_rows(QS_yest, QS_spring_total, QS_all_total, QS_all_unique) %>%
  rename(from_travel = travel_Grace,
         at_Grace = exposure_Grace,
         at_Home = exposure_Home)


#Maximum count needed for graphs
mQS <- max(QS_by_day$n, na.rm = TRUE)

##############################################################################
#Student Isolation Numbers

IS <- S_spring %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(ID:First_Name, Location2, Isolated, End_Date)

IS_by_day <- IS%>%
  #DELETE THE LINE BELOW ONCE ISOLATED DATA EXISTS
  add_row(ID = NA, First_Name = NA, Last_Name = NA, Location2 = NA, Isolated = (yest), End_Date = (yest+1)) %>%
  rowwise() %>%
  do(data.frame(.[1:5], Isolated = seq(.$Isolated, .$End_Date, by = "1 day")))

IS_yest <- IS_by_day %>%
  group_by(Isolated, Location2, .drop = FALSE)%>%
  summarise(n = n())%>%
  filter(Isolated == yest) %>%
  pivot_wider(names_from = Location2, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Total, Grace, Home)

IS_spring_total <- IS %>%
  group_by(Location2, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Location2, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Total, Grace, Home)

IS_all_total <- S_all %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(ID:First_Name, Location2, Isolated, End_Date)%>%
  group_by(Location2, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Location2, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Total, Grace, Home)

IS_all_unique <- S_all %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(ID:First_Name, Location2, Isolated, End_Date)%>%
  distinct(First_Name, Last_Name, .keep_all = TRUE)%>%
  group_by(Location2, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Location2, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Unique Students") %>%
  select(Type, Total, Grace, Home)

IS_Tab <- bind_rows(IS_yest, IS_spring_total, IS_all_total, IS_all_unique) %>%
  rename(at_Grace = Grace,
         at_Home = Home)

#Maximum count needed for graphs
mIS <- max(c(2, IS_by_day$n))

#########################################################################
#Student Cases

#Fill in dates between start of student quarantine and end date,
#Then total for each day
CS <- S_spring %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Result Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  select(ID:First_Name, Location2, Test_Date, End_Date)

CS_by_day <- CS %>%
  #DELETE THE LINE BELOW ONCE ISOLATED DATA EXISTS
  add_row(ID = NA, First_Name = NA, Last_Name = NA, Location2 = NA, Test_Date = (yest), End_Date = (yest+1)) %>%
  rowwise() %>%
  do(data.frame(.[1:5], Test_Date = seq(.$Test_Date, .$End_Date, by = "1 day")))

CS_yest <- CS_by_day %>%
  filter(Test_Date == yest) %>%
  group_by(Test_Date, Location2, .drop = FALSE) %>%
  summarise(n = n())%>%
  pivot_wider(names_from = Location2, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Total, Grace, Home)

CS_spring_total <- CS %>%
  group_by(Location2, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Location2, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Total, Grace, Home)

CS_all_total <- S_all %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Test Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  select(ID:First_Name, Location2, Test_Date, End_Date)%>%
  group_by(Location2, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Location2, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Total, Grace, Home)

CS_Tab <- bind_rows(CS_yest, CS_spring_total, CS_all_total) %>%
  rename(at_Grace = Grace,
         at_Home = Home)

#Maximum count needed for graphs
mCS <- max(c(2, CS_by_day$n))


################################################################################
#Employee Data

#Quarantine
#Fill in dates between start of student quarantine and end date
QE <- E_spring %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated >= Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(Last_Name:First_Name, Quarantine, End_Date)

#Then total for each day
QE_by_day <- QE %>%
  rename(Date = Quarantine) %>%
  rowwise() %>%
  do(data.frame(.[1:2], Date = seq(.$Date, .$End_Date, by = "1 day")))

QE_yest <- QE_by_day %>%
  group_by(Date, .drop = FALSE) %>%
  summarise(Quarantine = n()) %>%
  ungroup()%>%
  filter(Date == yest) %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Quarantine)

QE_spring_total <- QE %>%
  summarise(Quarantine = n()) %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Quarantine)

QE_all_total <- E_all %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated > Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(Last_Name:First_Name, Quarantine, End_Date) %>%
  summarise(Quarantine = n()) %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Quarantine)

QE_Tab <- bind_rows(QE_yest, QE_spring_total, QE_all_total)


#Maximum count needed for graphs
mQE <- max(QE_by_day$Quarantine, na.rm = TRUE)

############################################################################
#Employee Isolation Numbers

IE <- E_spring %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(Last_Name:First_Name, Isolated, End_Date)

IE_by_day <- IE%>%
  rowwise() %>%
  do(data.frame(.[1:2], Date = seq(.$Isolated, .$End_Date, by = "1 day")))

IE_yest <- IE_by_day %>%
  filter(Date == yest) %>%
  group_by(Date, .drop = FALSE)%>%
  summarise(Isolated = n()) %>%
  ungroup()%>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Isolated)

IE_spring_total <- IE %>%
  summarise(Isolated = n()) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Isolated)

IE_all_total <- E_all %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(Last_Name:First_Name, Isolated, End_Date)%>%
  summarise(Isolated = n()) %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Isolated)

IE_Tab <- bind_rows(IE_yest, IE_spring_total, IE_all_total)

#Maximum count needed for graphs
mIE <- max(c(2, IE_by_day$Isolated))

#########################################################################
#Employee Cases

#Fill in dates between start of student quarantine and end date,
#Then total for each day
CE <- E_spring %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Result Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  select(Last_Name:First_Name, Test_Date, End_Date)

CE_by_day <- CE %>%
  rowwise() %>%
  do(data.frame(.[1:2], Test_Date = seq(.$Test_Date, .$End_Date, by = "1 day")))

CE_yest <- CE_by_day %>%
  filter(Test_Date == yest) %>%
  group_by(Test_Date, .drop = FALSE) %>%
  summarise(Cases = n()) %>%
  ungroup()%>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Cases)

CE_spring_total <- CE %>%
  summarise(Cases = n()) %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Cases)

CE_all_total <- E_all %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Test Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  select(Last_Name:First_Name, Test_Date, End_Date)%>%
  summarise(Cases = n()) %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Cases)

CE_Tab <- bind_rows(CE_yest, CE_spring_total, CE_all_total)

#Maximum count needed for graphs
mCE <- max(c(2, CE_by_day$Cases))

#########################################################################

#Colors used for graphs
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
c_vals = gg_color_hue(2)
names(c_vals) <- rev(levels(S$Location2))

```

![Grace Logo](Logo-GC-Red-Background-Stretched.jpg)\

<center>
# Grace College Internal COVID-19 Data
## Compiled by Dr. Ryan Johnson using contact tracing data from Laura Green and Nicole Gibson, as well as testing data from the state of Indiana.
### Last updated `r format(Sys.time(), '%A, %B %d, %Y, at %I:%M%p')`
</center>

\vspace{2 in}

Notes and Irregularities:

  - Confirmed cases are matched to the date the test was taken, not the date of the test result.

\newpage

# Cases


### Confirmed Cases Among Students

As of yesterday, Grace College had

```{r, echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
CS_Tab %>%
  select(Type, Total, at_Home, at_Grace)%>%
  gt() %>%
  tab_header(title = "Student Cases") %>%
  cols_label(at_Grace = "At Grace", at_Home = "At Home")
```


```{r, echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
adjust = 1
CS_by_day %>%
  mutate(location = Location2) %>%
  ggplot(aes(x = Test_Date, fill = location)) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 0.75,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  ="1 month",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    scale_fill_manual(values = c_vals) +
    # Make this as high as the tallest column
    coord_fixed(ratio = max(mCS,5)) +
    ggtitle("Active Confirmed Cases Among Students Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Students") + 
    xlab("Date")+
    geom_hline(yintercept =  seq(0, mCS, 10)/mCS, linetype = "dotted")+
    annotate("text", x = spring,
             y = seq(0, mCS, 10)/mCS, label = seq(0, mCS, 10))+
    geom_vline(xintercept =  seq(spring, last, "months"))
```

### Confirmed Cases Among Employees

As of yesterday, Grace College had

```{r, echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
CE_Tab %>%
  gt() %>%
  tab_header(title = "Employee Cases")
```

```{r, echo=FALSE, fig.width=9, message=FALSE, warning=FALSE}
adjust = 1
CE_by_day %>%
  ggplot(aes(x = Test_Date, fill = "red")) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  ="1 month",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    # Make this as high as the tallest column
    coord_fixed(ratio = max(mCE,5)) +
    ggtitle("Active Confirmed Cases Among Employees Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Employees") + 
    xlab("Date") +
    theme(legend.position = "none")+
    geom_hline(yintercept =  seq(0, mCE, 10)/mCE, linetype = "dotted")+
    annotate("text", x = spring,
             y = seq(0, mCE, 10)/mCE, label = seq(0, mCE, 10))+
    geom_vline(xintercept =  seq(spring, last, "months"))
```

\newpage

# Isolated

### Isolated Students

```{r, echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
IS_Tab %>%
  select(Type, Total, at_Home, at_Grace)%>%
  gt() %>%
  tab_header(title = "Student Isolations") %>%
  cols_label(at_Grace = "At Grace", at_Home = "At Home")
```


```{r, echo=FALSE, fig.width=10, fig.height=5, message=FALSE, warning=FALSE}
adjust = 0.8
IS_by_day %>%
  mutate(location = Location2) %>%
  ggplot(aes(x = Isolated, fill = location)) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 0.75,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  ="1 month",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    scale_fill_manual(values = c_vals) +
    # Make this as high as the tallest column
    coord_fixed(ratio = max(mIS, 5)) +
    ggtitle("Active Isolated Students Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Students") + 
    xlab("Date") +
    geom_hline(yintercept =  seq(0, mIS, 10)/mIS, linetype = "dotted")+
    annotate("text", x = first,
             y = seq(0, mIS, 10)/mIS, label = seq(0, mIS, 10))+
    geom_vline(xintercept =  seq(spring, last, "months"))
```

### Isolated Employees

As of yesterday, Grace College had

```{r, echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
IE_Tab %>%
  gt() %>%
  tab_header(title = "Employee Isolations")
```

```{r, echo=FALSE, fig.width=9, fig.height=mIE/4 + 1, message=FALSE, warning=FALSE}
IE_by_day %>%
  ggplot(aes(x = Date, fill = "red")) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  ="1 month",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    # Make this as high as the tallest column
    coord_fixed(ratio = max(mIE+2, 5)) +
    ggtitle("Active Isolated Employees Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Employees") + 
    xlab("Date") +
    theme(legend.position = "none") +
    geom_hline(yintercept =  seq(0, mIE, 10)/mIE, linetype = "dotted")+
    annotate("text", x = first,
             y = seq(1, mIE+1, 10)/mIE, label = seq(0, mIE, 10))+
    geom_vline(xintercept =  seq(spring, last, "months"))
```

\newpage

# Quarantined

### Quarantined Students

```{r, echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
QS_Tab %>%
  mutate(at_Grace = at_Grace + from_travel) %>%
  select(Type, Total, at_Home, at_Grace, from_travel)%>%
  gt() %>%
  tab_header(title = "Student Quarantines",
             subtitle = "`From Travel` is a subcategory of `At Grace`") %>%
  cols_label(at_Grace = "At Grace", at_Home = "At Home")
```



```{r, echo=FALSE, fig.width=10, fig.height=6, message=FALSE, warning=FALSE}
adjust = 1
cf = max(mQS+2, 5)
QS_by_day %>%
  mutate(location = Location2) %>%
  ggplot(aes(x = Quarantine, fill = location)) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  ="1 month",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    scale_fill_manual(values = c_vals) +
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Quarantined Students Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Students") + 
    xlab("Date") +
    geom_hline(yintercept =  seq(0, mQS, 10)/cf, linetype = "dotted")+
    annotate("text", x = spring+2,
             y = seq(1, mQS, 10)/cf, label = seq(0, mQS, 10))+
      geom_vline(xintercept =  seq(spring, last, "months"))
```

### Quarantined Employees

As of yesterday, Grace College had

```{r, echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
QE_Tab %>%
  gt() %>%
  tab_header(title = "Employee Quarantines")
```

```{r, echo=FALSE, fig.width=9, fig.height=2, message=FALSE, warning=FALSE}
adjust = 1
cf = max(mQE+2, 5)
QE_by_day %>%
  ggplot(aes(x = Date, fill = "red")) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  ="1 month",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Quarantined Employees Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Employees") + 
    xlab("Date") +
    theme(legend.position = "none") +
    geom_hline(yintercept =  seq(0, mQE, 10)/cf, linetype = "dotted")+
    annotate("text", x = first,
             y = seq(1, mQE+1, 10)/cf, label = seq(0, mQE, 10))+
      geom_vline(xintercept =  seq(spring, last, "months"))
```


\newpage


```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
#Input parameters
cfirst = floor_date(yest-90, unit = "month")
clast = ceiling_date(yest, unit = "month")

K$CC7 <- c(rep(0,6), rollmean(K$COVID_COUNT, 7))
K$CT7 <- c(rep(0,6), rollmean(K$COVID_TESTS_ADMINISTRATED, 7))
K$CCT <- c(rep(0,4), rollsum(K$COVID_COUNT, 7), rep(0,2))
K$CTT <- c(rep(0,6), rollsum(K$COVID_TESTS_ADMINISTRATED, 7))

nK2 = nrow(K)
K$TEST_RATE <- K$CCT / K$CTT
K$TEST_RATE <- c(rep(NA, 3), K$TEST_RATE[seq(-nK2, length.out = 3)])

K <- subset(K, DATE > cfirst)
nK = nrow(K)

I$CC7 <- c(rep(0,6), rollmean(I$COVID_COUNT, 7))
I$CT7 <- c(rep(0,6), rollmean(I$COVID_TEST, 7))
I$CCT <- c(rep(0,4), rollsum(I$COVID_COUNT, 7), c(rep(0,2)))
I$CTT <- c(rep(0,6), rollsum(I$COVID_TEST, 7))

nI2 = nrow(I)
I$TEST_RATE <- I$CC7 / I$CT7
I$TEST_RATE <- c(rep(NA, 3), I$TEST_RATE[seq(-nI2, length.out = 3)])

I <- subset(I, DATE > cfirst)
nI = nrow(I)

weekspan <- 3*7/(as.numeric(clast) - as.numeric(cfirst)+2)
```

\newpage

# Kosciusko County
Kosciusko County has had

* `r K$COVID_COUNT_MOVING_AVG[[nK]]` cases per day the past week.
* `r sum(K$COVID_COUNT)` total confirmed cases.

### Cases - Kosciusko

```{r, echo=FALSE, fig.width=11, fig.height=5, message=FALSE, warning=FALSE}
ggplot(K, aes(x = DATE, y = COVID_COUNT)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle("Kosciusko New Confirmed Cases") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("New Cases") + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(cfirst, clast, "months"))
```

### Positivity - Kosciusko

Kosciusko County has had `r subset(K, DATE == yest - 7)$POSITIVE_TEST_RATE_MOVING_AVG`% 7-day positivity rate for unique indiviudals as of `r format(yest-7, "%B %d")`.



```{r, echo=FALSE, fig.width=11, fig.height=5, message=FALSE, warning=FALSE}
ggplot(subset(K, DATE < yest - 6), aes(x = DATE, y = POSITIVE_TEST_RATE_MOVING_AVG/100)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     limit=c(0,NA)) +
  ggtitle("Kosciusko Percentage of Positive Tests - 7 Day Rolling Average") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  geom_vline(xintercept =  seq(cfirst, clast, "months")) +
  geom_hline(yintercept = 0)
#* `r round(100 * K$TEST_RATE[[nK-5]], digits = 1)`% 7-day positivity rate as of `r format(yest-5, "%B %d")`.  This number is computed assuming an average 2-day wait for test results, and might not fit exactly with the positivity rate on the state's dashboard.
#* `r round(100 * K$TEST_RATE[[nK-5]], digits = 1)`% = `r K$CCT[[nK-8]]` / `r K$CTT[[nK-8]]`.
```

\newpage

# Indiana

The total case numbers below are multiplied by $\frac{\text{Kos pop}}{\text{Ind pop}} = \frac{79456}{6732000} = 0.01180273$, so that it is easier to compare Kosciusko numbers to the average Indiana county.

Indiana has had

* `r round(I$CC7[[nI]], digits = 1)` cases per day the past week (normalized `r round(I$CC7[[nI]]*79456/6732000, digits = 1)`).
* `r prettyNum(sum(I$COVID_COUNT),big.mark=",",scientific=FALSE)` total confirmed cases (normalized `r round(sum(I$COVID_COUNT)*79456/6732000, digits = 1)`).

### Cases - Indiana

```{r, echo=FALSE, fig.width=11, fig.height=5, message=FALSE, warning=FALSE}
ggplot(I, aes(x = DATE, y = COVID_COUNT * 79456/6732000)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle("Normalized Indiana New Confirmed Cases") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Normalized New Cases") + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(cfirst, clast, "months"))
```

### Positivity - Indiana

Indiana reports a `r round(subset(I, DATE == yest - 7)$POSITIVITY_RATE_ALL_TESTS, 1)`% 7-day positivity rate for all tests as of `r format(yest-7, "%B %d")`.

```{r, echo=FALSE, fig.width=11, fig.height=5, message=FALSE, warning=FALSE}
ggplot(subset(I, DATE <= yest - 7), aes(x = DATE, y = POSITIVITY_RATE_ALL_TESTS/100)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     limit=c(0,NA)) +
  ggtitle("Indiana Average Positivity Rate for All Tests") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(cfirst, clast, "months"))

#* `r round(100 * I$TEST_RATE[[nI-5]], digits = 1)`% 7-day positivity rate as of `r format(yest-6, "%B %d")`.  This number is computed assuming an average 2-day wait for test results, and might not fit exactly with the positivity rate on the state's dashboard.
#* `r round(100 * I$TEST_RATE[[nI-5]], digits = 1)`% = `r prettyNum(I$CCT[[nI-8]],big.mark=",",scientific=FALSE)` / `r prettyNum(I$CTT[[nI-8]], ,big.mark=",",scientific=FALSE)`.
```

\newpage
# Indiana Map

The map below displays the cases per 100,000 per day averaged over the past week and the positivity rate for unique individuals averaged over the previous week.

```{r, echo=FALSE, fig.width=12, fig.height=14, warning=FALSE, message=FALSE}
lat_and_long <- read_excel("lat_and_long.xlsx")
lat_and_long$COUNTY_NUMERIC <- lat_and_long$COUNTY_NUMERIC + 18000
load("county_populations.RData")
county_data <- merge(x = pops, y = lat_and_long,
                     by.x = "key_numeric",
                     by.y = "COUNTY_NUMERIC")


counties_yest <- IN_counties[IN_counties$DATE == yest-7,]
counties_yest$COVID_COUNT_MOVING_AVG <- IN_counties[IN_counties$DATE == yest-1,]$COVID_COUNT_MOVING_AVG

Indices <- merge(x = counties_yest, y = county_data,
                 by.x = "LOCATION_ID",
                 by.y = "key_numeric")
Indices$Case_per <- Indices$COVID_COUNT_MOVING_AVG / Indices$population * 1000
Indices$case_index <- Indices$Case_per/sum(Indices$Case_per)
Indices$positivity_index <- Indices$POSITIVE_TEST_RATE_MOVING_AVG/sum(Indices$POSITIVE_TEST_RATE_MOVING_AVG)
Indices$combined <- sqrt(Indices$case_index * Indices$positivity_index)
Indices$dashboard <- Indices$Case_per/2 + Indices$POSITIVE_TEST_RATE_MOVING_AVG/10
Indices <- Indices[order(-Indices$combined),]
outbreaks <- Indices$county[1:6]

Indices$fips <- Indices$LOCATION_ID

Ind_trans <- subset(Indices, select = c(PRIM_LONG_DEC,
                                        PRIM_LAT_DEC,
                                        LOCATION_ID,
                                        COUNTY_NAME.x,
                                        combined,
                                        Case_per,
                                        POSITIVE_TEST_RATE_MOVING_AVG))
Ind_trans$labels <- paste0(Ind_trans$COUNTY_NAME.x, "\n",
                           round(100*Ind_trans$Case_per,0), " & ",
                           round(Ind_trans$POSITIVE_TEST_RATE_MOVING_AVG,0), "%")
Ind_map <- usmap_transform(Ind_trans)

plot_usmap("counties",
           data = Indices, values = "combined", color = "blue",
           include = Indices$fips, labels = FALSE) + 
    ggplot2::scale_fill_continuous(low = "white", high = "red") + 
    theme(legend.position = "none") +
    geom_text(data = Ind_map,
              aes(x = PRIM_LONG_DEC.1,
                  y = PRIM_LAT_DEC.1,
                  label = labels))
```
