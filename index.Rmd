---
title: "COVID19 Data Near Kosciusko County"
author: "Compiled by Dr. Ryan Johnson using data from @NYT based on reports from state and local health agencies by way of @COVID19."
date: "Last updated `r format(Sys.time(), '%A, %B %d, %Y')`"
output:
  html_document:
    df_print: paged
bibliography: bibliography.bib
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
library(COVID19)
require(tidyverse)
library(dplyr)
library(lubridate)
library(scales)
library(usmap)
library(tigris)

#Input parameters
per = 8*10^4 #dislplay rates per how many people?
per_word = "Eighty Thousand"
data_start = as.Date("2020-03-20") #Start data at this day
states <- c("Michigan", "Illinois", "Ohio", "Kentucky")
KOS_neighbor_counties <- c("Fulton", "Marshall", "Elkhart", "Noble", "Whitley", "Allen", "Wabash")
#outbreaks = c("Cass", "Marion", "Decatur", "Lake")

#What is the latest date of the data?
yest <- Sys.Date() - 1

#Get data and subset to states we want
US_states <- covid19("US", level = 2, start = data_start, end = yest)

#Get per-day numbers
US_states$difdeaths <- prepend(diff(US_states$deaths), 0)
US_states$difconfirmed <- prepend(diff(US_states$confirmed), 0)
US_states$diftests <- prepend(diff(US_states$tests), 0)

#Get per-population numbers
US_states$confirmedper <- US_states$confirmed / US_states$population * per
US_states$deathsper <- US_states$deaths / US_states$population * per
US_states$testsper <- US_states$tests / US_states$population * per
US_states$difconfirmed_per <- US_states$difconfirmed / US_states$population * per
US_states$difdeaths_per <- US_states$difdeaths / US_states$population * per
US_states$diftests_per <- US_states$diftests / US_states$population * per
US_states$hosp_per <- US_states$hosp / US_states$population * per

#Some convenient date subsets
covyest <- US_states[US_states$date == yest,]
covlabel <- US_states[US_states$date == as.Date("2020-04-20"),]
cov5 <- US_states[US_states$date <= yest & US_states$date > (yest - 5),]
cov14 <- US_states[US_states$date <= yest & US_states$date > (yest - 14),]

#State-level subsets
Indiana <- subset(US_states, administrative_area_level_2 == "Indiana")
IN_neighbors <- subset(US_states, administrative_area_level_2 %in% states)

#County Level Data
US_counties <- covid19("US", level = 3, start = data_start, end = yest)
IN_counties <- subset(US_counties,
                      administrative_area_level_2 == "Indiana")
IN_counties$county <- as.factor(IN_counties$administrative_area_level_3)

#Fix typo in DeKalb County
IN_counties[IN_counties$date == "2020-04-13" & IN_counties$county == "DeKalb", "confirmed"] <- 6

#Get per-day numbers
IN_counties$difdeaths <- prepend(diff(IN_counties$deaths), 0)
IN_counties$difconfirmed <- prepend(diff(IN_counties$confirmed), 0)
IN_counties$diftests <- prepend(diff(IN_counties$tests), 0)

#Weird Date Correction
#new_start = date_start + 1
IN_counties <- subset(IN_counties, IN_counties$date > data_start)

#Get per-population numbers
IN_counties$confirmedper <- IN_counties$confirmed / IN_counties$population * per
IN_counties$deathsper <- IN_counties$deaths / IN_counties$population * per
IN_counties$testsper <- IN_counties$tests / IN_counties$population * per
IN_counties$difconfirmed_per <- IN_counties$difconfirmed / IN_counties$population * per
IN_counties$difdeaths_per <- IN_counties$difdeaths / IN_counties$population * per
IN_counties$diftests_per <- IN_counties$diftests / IN_counties$population * per

IN7 <- IN_counties[IN_counties$date <= yest & IN_counties$date > (yest - 7),]
Indices <- aggregate(cbind(difconfirmed_per, difdeaths_per) ~ county, data = IN7, FUN = sum)
Indices$case_index <- Indices$difconfirmed_per/sum(Indices$difconfirmed_per)
Indices$death_index <- Indices$difdeaths_per/sum(Indices$difdeaths_per)
Indices$combined <- sqrt(Indices$case_index^2 + Indices$death_index^2)
Indices <- Indices[order(-Indices$combined),]
outbreaks <- Indices$county[1:6]

Indices$fips <- fips("IN", county = Indices$county)

Kos <- subset(IN_counties, county == "Kosciusko", date < yest)
IN_outbreak <- subset(IN_counties, county %in% outbreaks)
KOS_neighbors <- subset(IN_counties, county %in% KOS_neighbor_counties)

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

weekspan <- 5*7/(as.numeric(yest) - as.numeric(data_start)+2)
```

&nbsp;

#### All counts will be reported as per 80,000 because that is roughly the population of Kosciusko County.

&nbsp;

# Indiana State Data

&nbsp;

### Hospitalizations - Indiana

Govenor Holcomb as decided that hopspitalization numbers are one of the most important indicators for how we are doing.

This graph starts much later than the others because hospitalization numbers were not reported until April 25.

The blue dashed lines are smoothed weighted averages.

```{r, echo=FALSE, fig.width=6, fig.height=3, message=FALSE}
IN_Hosp <- subset(Indiana, date >= as.Date("2020-04-25"))
ggplot(IN_Hosp, aes(x = date, y = hosp_per)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Indiana Hospitalizations per", per_word, "People")) + 
  theme(plot.title = element_text(hjust = 0.5), legend.text = element_text(size = 15)) + 
  ylab(paste("Hosps per", as.character(per), "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE,
              linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

### Cases - Indiana

```{r, echo=FALSE, fig.width=12, fig.height=5, message=FALSE, warning=FALSE}
ggplot(Indiana, aes(x = date, y = difconfirmed_per)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Indiana New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed",
              span = weekspan) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

### Percentage of Positive Tests

The percentage of tests coming back positive is one way to measure the prevalence of testing.

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning = FALSE}
ggplot(Indiana, aes(x = date, y = (difconfirmed / diftests))) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
  coord_cartesian(ylim = c(0,.5)) +
  scale_y_continuous(oob = squish, labels = scales::percent) +
  ggtitle("Indiana Percentage of Positive Tests Each Day") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  geom_point(size = 4) +
  stat_smooth(linetype = "dashed", se = FALSE, span = weekspan) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

### Deaths - Indiana

```{r, echo=FALSE, fig.width=12, fig.height=5, message=FALSE, warning=FALSE}
ggplot(Indiana, aes(x = date, y = difdeaths_per)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Indiana New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

&nbsp;

# Kosciusko Data

&nbsp;

Note that the y-axis scales of these graphs are different than the state-level data.

### Cases - Kosciusko

```{r, echo=FALSE, fig.width=12, fig.height=5, message=FALSE, warning=FALSE}
ggplot(Kos, aes(x = date, y = difconfirmed_per)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Kosciusko New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

### Deaths - Kosciusko

Note that if the number of deaths below is more than the official count according to Kosciusko county, that is most likely because our data source is also counting non-residents of Kosciusko county who have died in Koscisusko county.

```{r, echo=FALSE, fig.width=12, fig.height=5, message=FALSE, warning=FALSE}
ggplot(Kos, aes(x = date, y = difdeaths_per)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Kosciusko New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

&nbsp;

# Indiana Outbreaks

The coloring scheme for the map below is based on a combination of new cases and new deaths per captita in the past week.  The coloring scheme is relative, it will always color the worst county pure red.

```{r, echo=FALSE, fig.width=12, fig.height=14, warning=FALSE, message=FALSE}
plot_usmap("counties",
           data = Indices, values = "combined", color = "blue",
           include = Indices$fips, labels = TRUE) + 
    scale_fill_continuous(name = "Outbreak Index",
                          low = "white", high = "red") + 
    theme(legend.position = "right")
```




Below are the six counties in Indiana with the worst combination of new confirmed cases and new confirmed deaths over the past week.

Note that the y-axis scales of these graphs are different than other sections.

### Cases - Outbreaks in Indiana

The first chart is a comparison of smoothed weighted averages. The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
ggplot(IN_outbreak, aes(x = date,
                     y = difconfirmed_per, color = county)) + 
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

The chart below does not contain two outliers for Cass County.  On April 26th, Cass County reported 271 new cases (575 per 80,000), and on April 27th, Cass County reported 439 new cases (932 per 80,000).

```{r echo=FALSE, fig.width=12, fig.height=5, message = FALSE, warning=FALSE}
ggplot(IN_outbreak, aes(x = date, y = difconfirmed_per, color = county)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="6 days",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
#Include if Cass is in  coord_cartesian(ylim = c(0,200)) +
  scale_y_continuous(oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(county), nrow = 3, ncol = 2) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```


### Deaths - Outbreaks in Indiana

The first chart is a comparison of smoothed weighted averages. The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
ggplot(IN_outbreak, aes(x = date,
                     y = difdeaths_per, color = county)) + 
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning = FALSE}
#Plot Deaths per Million per Day
ggplot(IN_outbreak, aes(x = date, y = difdeaths_per, color = county)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="6 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(county), nrow = 3, ncol = 2) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

&nbsp;

# Neighboring Counties

&nbsp;

Note that the y-axis scales of these graphs are different than other sections.

### Cases - Counties Neighboring Kosciusko

The first chart is a comparison of smoothed weighted averages.  The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
KOS_plus <- rbind(KOS_neighbors, Kos)
KOS_plus$county <- droplevels(KOS_plus$county)
n = length(KOS_neighbor_counties)
m = match("Kosciusko", levels(KOS_plus$county)) - 1
c_vals = append(gg_color_hue(n), "black", after = m)
names(c_vals) <- levels(KOS_plus$county)
ggplot(KOS_plus, aes(x = date,
                     y = difconfirmed_per, color = county)) + 
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="6 days",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") + 
  scale_color_manual(values = c_vals) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

```{r, echo=FALSE, fig.width=12, fig.height=8, warning=FALSE, message=FALSE}
#Plot Confirmed per Million per Day
#breaks <- 10^(-10:10)
#minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))
ggplot(KOS_neighbors, aes(x = date, y = difconfirmed_per, color = county)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="6 days",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  facet_wrap(vars(county), nrow = 6, ncol = 2) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```


&nbsp;

### Deaths - Counties Neighboring Kosciusko

The first chart is a comparison of smoothed weighted averages.  The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
ggplot(KOS_plus, aes(x = date,
                     y = difdeaths_per, color = county)) + 
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="6 days",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") + 
  scale_color_manual(values = c_vals) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

```{r, echo=FALSE, fig.width=12, fig.height=8, warning=FALSE, message=FALSE}
#Plot Confirmed per Million per Day
#breaks <- 10^(-10:10)
#minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))
ggplot(KOS_neighbors, aes(x = date, y = difdeaths_per, color = county)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="6 days",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(hjust = 0.5), legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths", per_word, "People")) + 
  xlab("Date") +
  facet_wrap(vars(county), nrow = 6, ncol = 2) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```


&nbsp;

# Neighboring States Data

&nbsp;

Note that the y-axis scales of these graphs are different than other sections.

### Cases - States Neighboring Indiana

The first plot is a comparison of smoothed weighted averages.  The second is the actual data.

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
IN_and_neighbors <- rbind(IN_neighbors, Indiana)
ggplot(IN_and_neighbors, aes(x = date, y = difconfirmed_per, color = administrative_area_level_2)) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Cases per Day per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Cases per Day per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_color_manual(values = c("Indiana" = "black", "Michigan" = "#00BFC4", "Illinois" = "#F8766D", "Ohio" = "#C77CFF", "Kentucky" = "#7CAE00")) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

```{r, echo=FALSE, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
ggplot(IN_neighbors, aes(x = date, y = difconfirmed_per, color = administrative_area_level_2)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="6 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Cases per Day per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Cases per Day per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(administrative_area_level_2), nrow = 3, ncol = 2) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```


### Deaths - States Neighboring Indiana

The first plot is a comparison of smoothed weighted averages.  The second is the actual data.

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
ggplot(IN_and_neighbors, aes(x = date, y = difdeaths_per, color = administrative_area_level_2)) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Deaths per Day per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Deaths per Day per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_color_manual(values = c("Indiana" = "black", "Michigan" = "#00BFC4", "Illinois" = "#F8766D", "Ohio" = "#C77CFF", "Kentucky" = "#7CAE00")) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

```{r, echo=FALSE, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
ggplot(IN_neighbors, aes(x = date, y = difdeaths_per, color = administrative_area_level_2)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="6 days",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Deaths per Day per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Deaths per Day per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(administrative_area_level_2), nrow = 3, ncol = 2) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```


### Positive Test Rate - States Neighboring Indiana

Looking at the percentage of tests that come back positive can signal which states might have low case numbers because of lack of testing.

For example, Michigan had a much higher death rate per capita than Illinois in mid-April, even though their case numbers per capita were only a little higher in late March and early April.  Michigan's high postive test rate late March and early April suggests that Michigan had worse testing than Illinois during that time.

The first plot is a comparison of smoothed weighted averages.  The second is the actual data.

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning = FALSE}
#Plot Deaths per Million per Day
ggplot(IN_and_neighbors, aes(x = date, y = (difconfirmed / diftests), color = administrative_area_level_2)) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="5 days",
               minor_breaks = "1 day") + 
  coord_cartesian(ylim = c(0,.5)) +
  scale_y_continuous(limit=c(0,NA),
                     oob = squish,
                     labels = scales::percent) +
  ggtitle("Percentage of Positive Tests Each Day") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_color_manual(values = c("Indiana" = "black", "Michigan" = "#00BFC4", "Illinois" = "#F8766D", "Ohio" = "#C77CFF", "Kentucky" = "#7CAE00")) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

Warning: the plots below contain several outliers where 

```{r, echo=FALSE, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
ggplot(IN_neighbors, aes(x = date, y = (difconfirmed / diftests), color = administrative_area_level_2)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="6 days",
               minor_breaks = "1 day") + 
  coord_cartesian(ylim = c(0,.5)) +
  scale_y_continuous(limit=c(0,NA),
                     oob = squish,
                     labels = scales::percent) +
  ggtitle("Percentage of Positive Tests Each Day") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Percent Positive", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(administrative_area_level_2), nrow = 3, ncol = 2) +
  geom_vline(xintercept = as.Date("2020-05-01")) +
  geom_vline(xintercept = as.Date("2020-04-01")) +
  geom_vline(xintercept = as.Date("2020-06-01"))
```

&nbsp;

# US outbreaks by state

The coloring scheme for the map below is based on a combination of average hospitalizations and new deaths per captita in the past week.  The coloring scheme is relative, it will always color the worst state pure red.

```{r, echo=FALSE, fig.width=12, fig.height=14, warning=FALSE, message=FALSE}
US7 <- US_states[US_states$date <= yest & US_states$date > (yest - 7),]
US7$state <- US7$administrative_area_level_2
US_Indices <- aggregate(cbind(hosp_per, difdeaths_per) ~ state, data = US7, FUN = sum)
US_Indices$hosp_index <- US_Indices$hosp_per/sum(US_Indices$hosp_per)
US_Indices$death_index <- US_Indices$difdeaths_per/sum(US_Indices$difdeaths_per)
US_Indices$combined <- sqrt(US_Indices$hosp_index^2 + US_Indices$death_index^2)
plot_usmap("states",
           data = US_Indices, values = "combined", color = "blue",
           include = US_Indices$fips, labels = TRUE) + 
    scale_fill_continuous(name = "Outbreak Index",
                          low = "white", high = "red") + 
    theme(legend.position = "right")
```


&nbsp;

# US outbreaks by county

The coloring scheme for the map below is based on a combination of new confirmed cases per capita and new deaths per captita in the past week.  The coloring scheme is relative, it will always color the worst state pure red.

```{r, echo=FALSE, fig.width=12, fig.height=14, warning=FALSE, message=FALSE, warning=FALSE, results='hide'}
US_counties$difdeaths <- prepend(diff(US_counties$deaths), 0)
US_counties$difconfirmed <- prepend(diff(US_counties$confirmed), 0)
US_counties$diftests <- prepend(diff(US_counties$tests), 0)
US_counties$difconfirmed_per <- US_counties$difconfirmed / US_counties$population * per
US_counties$difdeaths_per <- US_counties$difdeaths / US_counties$population * per
US_counties$diftests_per <- US_counties$diftests / US_counties$population * per
US7c <- US_counties[US_counties$date <= yest & US_counties$date > (yest - 7),]
US7c$county <- factor(US7c$administrative_area_level_3)
US7c$state <- factor(US7c$administrative_area_level_2)
USc_Indices <- aggregate(cbind(difconfirmed_per, difdeaths_per) ~ state + county, data = US7c, FUN = sum)

#Fix errors
USc_Indices <- subset(USc_Indices, USc_Indices$county != "Out of GA")
USc_Indices <- subset(USc_Indices, USc_Indices$county != "Out of TN")
USc_Indices <- subset(USc_Indices, USc_Indices$county != "Kansas City")
USc_Indices <- subset(USc_Indices, USc_Indices$county != "New York City")
USc_Indices <- subset(USc_Indices, USc_Indices$county != "City of Joplin")
USc_Indices <- subset(USc_Indices, USc_Indices$state != "Alaska")
VAc <- counties("Virginia", cb = TRUE)
VAC <- data.frame("county" = VAc$NAME, "FIP" = VAc$COUNTYFP)
VAC <- subset(VAC, FIP < 200)
USc_Indices <- subset(USc_Indices, USc_Indices$state != "Virginia" | USc_Indices$county %in% VAC$county)
USc_Indices$county <- as.character(USc_Indices$county)
USc_Indices[USc_Indices$state == "Louisiana",]$county <- paste(USc_Indices[USc_Indices$state == "Louisiana",]$county, "Parish")
USc_Indices[USc_Indices$state == "Louisiana" & USc_Indices$county == "LaSalle Parish",]$county <- "La Salle Parish"
USc_Indices$county <- as.factor(USc_Indices$county)


USc_Indices$confirmed_index <- USc_Indices$difconfirmed_per/sum(USc_Indices$difconfirmed_per)
USc_Indices$death_index <- USc_Indices$difdeaths_per/sum(USc_Indices$difdeaths_per)
USc_Indices$combined <- (USc_Indices$confirmed_index^2 + USc_Indices$death_index^2)^(1/5)

USc_Indices$fips <- NA
for (state in c("Alabama", levels(US7c$state)[3:51])){
     USc_Indices[USc_Indices$state == state,]$fips <- fips(state = state, county = USc_Indices[USc_Indices$state == state,]$county)
}

states <- plot_usmap("states", color = "black", fill = alpha(0.01))
counties <- plot_usmap(data = USc_Indices,
                       values = "combined",
                       include = USc_Indices$fips,
                       color = "black",
                       size = 0.1)
ggplot() +
  counties$layers[[1]] + #counties needs to be on top of states for this to work
  states$layers[[1]] +
  counties$theme + 
  coord_equal() +
  theme(legend.position="none") +
  scale_fill_gradient(low='white', high='red')
```

Data Sources: