---
title: "COVID19 Data Near Kosciusko County"
author: "Compiled by Dr. Ryan Johnson using data from @NYT based on reports from state and local health agencies by way of @COVID19."
date: "Last updated `r format(Sys.time(), '%A, %B %d, %Y')`"
output:
  html_document:
    df_print: paged
bibliography: bibliography.bib
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
library(COVID19)
require(tidyverse)
library(dplyr)
library(lubridate)
library(scales)
library(usmap)
library(tigris)
library(rmarkdown)
library(tidyverse)
library(readxl)
library(httr)
library(zoo)
library(data.table)
library(usmap)
library(useful)
library(tidygeocoder)
library(ggmap)
library(gt)

#Update Grace Internal Data
#fname = paste0('G:/Shared drives/Dashboard - COVID-19/Grace internal ',
#              format(Sys.time(), '%Y-%m-%d'),
#              '.pdf')
#rmarkdown::render('Grace_internal2.Rmd', output_file = fname)

#Input parameters
per = 8*10^4 #dislplay rates per how many people?
per_word = "Eighty Thousand"
data_start = as.Date("2020-03-20") #Start data at this day
states <- c("Michigan", "Illinois", "Ohio", "Kentucky")
KOS_neighbor_counties <- c("Fulton", "Marshall", "Elkhart", "Noble", "Whitley", "Allen", "Wabash")

#What is the latest date of the data?
yest <- Sys.Date() - 1 #Weird stuff going on with updating of data

#Get data and subset to states we want
US_states <- covid19("US", level = 2, start = data_start, end = yest) %>%
  #Compute per-day numbers from totals
  mutate(difdeaths = prepend(diff(deaths), 0),
         difconfirmed = prepend(diff(confirmed), 0),
         diftests = prepend(diff(tests), 0)) %>%
  #Compute per-population numbers
  mutate(confirmedper = confirmed / population * per,
         deathsper = deaths / population * per,
         testsper = tests / population * per,
         difconfirmed_per = difconfirmed / population * per,
         difdeaths_per = difdeaths / population * per,
         diftests_per = diftests / population * per,
         hosp_per = hosp / population * per)
  

#Some convenient date subsets
covyest <- US_states[US_states$date == yest,]
covlabel <- US_states[US_states$date == as.Date("2020-04-20"),]
cov5 <- US_states[US_states$date <= yest & US_states$date > (yest - 5),]
cov14 <- US_states[US_states$date <= yest & US_states$date > (yest - 14),]

#State-level subsets
Indiana <- subset(US_states, administrative_area_level_2 == "Indiana")
IN_neighbors <- subset(US_states, administrative_area_level_2 %in% states)


#County Level Data
url = "https://hub.mph.in.gov/dataset/bd08cdd3-9ab1-4d70-b933-41f9ef7b809d/resource/afaa225d-ac4e-4e80-9190-f6800c366b58/download/covid_report_county_date.xlsx"
GET(url, write_disk(tf <- tempfile(fileext = ".xlsx")))
IN_counties <- read_excel(tf)%>%
  #Correct data structures
  mutate(DATE = as.Date(DATE),
         COUNTY_NAME = factor(COUNTY_NAME))%>%
  #Filter after data_start
  filter(DATE > data_start) %>%
  #Compute per-day numbers
  mutate(difdeaths = COVID_DEATHS,
         difconfirmed = COVID_COUNT)

#Hospital Data
url = "https://hub.mph.in.gov/dataset/4d31808a-85da-4a48-9a76-a273e0beadb3/resource/0c00f7b6-05b0-4ebe-8722-ccf33e1a314f/download/covid_report_bedvent_date.xlsx"
GET(url, write_disk(tf <- tempfile(fileext = ".xlsx")))
IN_hosp <- read_excel(tf) %>%
  mutate(DATE = as.Date(DATE))%>%
  filter(DATE > as.Date("2020-04-07"))%>%
  rename(covid = PCT_BEDS_ICU_OCCUPIED_COVID_19,
         non_covid = PCT_BEDS_ICU_NO_OCCUPIED_COVID_19,
         available = PCT_BEDS_AVAILABLE_ICU_BEDS_TOTAL) %>%
  select(DATE, covid:available)%>%
  pivot_longer(cols = covid:available,
               names_to = "percent") %>%
  mutate(percent = factor(percent,levels = c("covid",
                                             "non_covid",
                                             "available")))

#More Hospital Data
round_date(yest, unit = "week", week_start = 7)
yest_str = format(floor_date(yest, unit = "week", week_start = 7), format = "%Y%m%d")
url = str_glue("https://healthdata.gov/sites/default/files/reported_hospital_capacity_admissions_facility_level_weekly_average_timeseries_","{yest_str}", ".csv")
US_indiv_hosp <- read.csv(url) %>%
  select(c(2:10, 22, 24, 26)) %>%
  rename(total = total_icu_beds_7_day_avg,
         used = icu_beds_used_7_day_avg,
         covid = staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg,
         fips = fips_code) %>%
  mutate(covid = replace(covid, which(covid < 0L), 2), #Choosing 2 is arbitrary, but I don't think it will matter
         used = replace(used, which(used < 0L), NA),    
         total = replace(total, which(total < 0L), NA), 
         fips = case_when(
           str_length(fips) == 4 ~ str_pad(fips, width = 5, side = "left", pad = 0),
           TRUE ~ as.character(fips))) %>%
  filter(!is.na(used),
         !is.na(total),
         address != '',
         ccn != '',
         collection_week == max(collection_week)) %>%
  mutate(used_pct = used/total,
         cov_pct = covid/total) %>%
  filter(used_pct > 0.9)

#Commented out because it takes too long.  Join with 
#US_indiv_hosp2 <- US_indiv_hosp %>%
#  filter(!is.na(used),
#         !is.na(total),
#         address != '',
#         ccn != '') %>%
#  geocode(street = address,
#          city = city,
#          postalcode = zip,
#          state = state) %>%
#  filter(!is.na(lat))
#View(US_indiv_hosp2)
#save(US_indiv_hosp2, file = "hosps_coords.R")
load("hosps_coords.R")

#Find any hospitals from US_indiv_hosp that don't have lat-long data, and add it with Google geocode
US_indiv_hosp2 <- US_indiv_hosp %>%
  anti_join(US_indiv_hosp2, by = "ccn") %>%
  add_row(address = "", city = "", state = "", zip = 0) %>%
  mutate(location = str_glue("{address}, {city}, {state}, {zip}")) %>%
  mutate_geocode(location) %>%
  rename(long = lon) %>%
  select(collection_week:covid, lat, long) %>%
  rbind(US_indiv_hosp2) %>%
  filter(!is.na(ccn))

save(US_indiv_hosp2, file = "hosps_coords.R") #Save for next time



US_indiv_hosp3 <- US_indiv_hosp2 %>%
  select(ccn, lat, long) %>%
  right_join(US_indiv_hosp, by = "ccn")%>%
  relocate(long, lat) %>%
  drop_na() %>%
  usmap_transform() %>%
  mutate(used_pct = ifelse(used_pct > 1, 1, used_pct),
         cov_pct = ifelse(cov_pct > 1, 1, cov_pct))

IN_county_hosp <- US_indiv_hosp %>%
  group_by(state, fips) %>%
  summarise(total = sum(total, na.rm = TRUE),
            used = sum(used, na.rm = TRUE),
            covid = sum(covid, na.rm = TRUE)) %>%
  mutate(cov_pct = covid/total,
         non_pct = (used-covid)/total)

#Add geographic and population data
lat_and_long <- read_excel("lat_and_long.xlsx") %>%
  mutate(COUNTY_NUMERIC = COUNTY_NUMERIC + 18000)
load("county_populations.RData")
IN_counties <- pops %>%
  full_join(y = lat_and_long,
            by = c("key_numeric"="COUNTY_NUMERIC"))%>%
  mutate(key_numeric = as.character(key_numeric))%>%
  full_join(y = IN_counties,
            by = c("key_numeric" = "LOCATION_ID")) %>%
  #Compute per-population numbers
  mutate(confirmedper = COVID_COUNT / population * per,
         deathsper = COVID_DEATHS / population * per,
         difconfirmed_per = difconfirmed / population * per,
         difdeaths_per = difdeaths / population * per,
         county = COUNTY_NAME.x) %>%
  left_join(y = IN_county_hosp,
            by = c("key_numeric" = "fips"))

Indices <- IN_counties %>%
  group_by(COUNTY_NAME.x) %>%
  mutate(POSITIVE_TEST_RATE_MOVING_AVG = lag(POSITIVE_TEST_RATE_MOVING_AVG, 6),
         ALL_TESTS_POSITIVE_TEST_RATE_MOVING_AVG =
           lag(ALL_TESTS_POSITIVE_TEST_RATE_MOVING_AVG, 6)) %>%
  filter(DATE == yest-1) %>%
  ungroup() %>%
  mutate(Case_per = COVID_COUNT_MOVING_AVG / population * per,
         case_index = Case_per/sum(Case_per),
         positivity_index = POSITIVE_TEST_RATE_MOVING_AVG/sum(POSITIVE_TEST_RATE_MOVING_AVG),
         combined = sqrt(case_index * positivity_index),
         dashboard = Case_per/2 + POSITIVE_TEST_RATE_MOVING_AVG/10,
         fips = key_numeric)
 
Indices <- Indices[order(-Indices$combined),]
outbreaks <- Indices$COUNTY_NAME.x[1:6] 

Kos <- subset(IN_counties, county == "Kosciusko", DATE < yest)
IN_outbreak <- subset(IN_counties, county %in% outbreaks)
KOS_neighbors <- subset(IN_counties, county %in% KOS_neighbor_counties)

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

weekspan <- 3*7/(as.numeric(yest) - as.numeric(data_start)+2)
```

&nbsp;

#### All counts will be reported as per 80,000 because that is roughly the population of Kosciusko County.

&nbsp;

# Indiana State Data

&nbsp;

### Hospitalizations - Indiana

Because hospitalizations are smoother than cases or deaths, we present the data with a line graph below:

```{r, echo=FALSE, fig.width=12, fig.height=5, message=FALSE, warning=FALSE}
#IN_Hosp <- subset(Indiana, date >= as.Date("2020-04-25"))
ggplot(Indiana, aes(x = date, y = hosp_per)) + 
  geom_line(size = 3) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(1,NA)) +
  ggtitle(paste("Indiana Hospitalizations per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Hosps per", as.character(per), "People")) + 
  xlab("Date") +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

### Available ICU Beds

```{r, echo=FALSE, fig.width=12, fig.height=6, message=FALSE, warning=FALSE}
IN_hosp %>%
  filter(percent != "available") %>%
ggplot(aes(x = DATE, y = value/100)) + 
  geom_area(aes(colour = percent, fill= percent),
            position = 'stack') +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day",
               limits = c(data_start, yest)) + 
  scale_y_continuous(limit=c(0,1.01),
                     labels = scales::percent) +
  ggtitle("Indiana ICU Bed Usage") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15),
        legend.direction = "horizontal",
        legend.position = "bottom") + 
  ylab("Hospitalization Usage") + 
  xlab("Date") +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months")) +
  geom_hline(yintercept = c(0,1))
```

### Hospitals Accross the US with over 90% ICU beds in use

```{r, echo=FALSE, fig.width=12, fig.height=6, message=FALSE, warning=FALSE}
plot_usmap() +
  geom_point(data = US_indiv_hosp3, aes(x = long.1, y = lat.1, size = total, color = cov_pct),
             alpha = 1) +
  labs(title = "US Hospitals above 90% Capacity of ICU Beds",
       subtitle = "Source: https://healthdata.gov",
       size = "ICU Beds", color = "COV19%") +
  theme(legend.position = "right") +
  scale_colour_gradient(low = "yellow", high = "red", labels = percent) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) 
```

```{r, echo=FALSE, fig.width=12, fig.height=6, message=FALSE, warning=FALSE}
IN_indiv_hosp <- US_indiv_hosp3 %>%
  filter(state == "IN")
plot_usmap(include = "IN") +
  geom_point(data = IN_indiv_hosp, aes(x = long.1, y = lat.1, size = total, color = cov_pct),
             alpha = 1) +
  labs(title = "Indiana Hospitals above 90% Capacity of ICU Beds",
       subtitle = "Source: https://healthdata.gov",
       size = "ICU Beds", color = "COV19%") +
  theme(legend.position = "right") +
  scale_colour_gradient(low = "yellow", high = "red", labels = percent) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) 
```

```{r, echo=FALSE, fig.width=12, fig.height=6, message=FALSE, warning=FALSE}
US_indiv_hosp %>%
  filter(state %in% c("IN")) %>% #, "IL", "OH", "KY", "MI")) %>%
  mutate(state = factor(state, levels = c("IN"))) %>% #, "MI", "OH", "IL", "KY")))%>%
  select(hospital_name, city, total, used_pct, cov_pct) %>%
  gt() %>%
  tab_header(
    title = "Hospitals in Indiana With Over 90% ICU Beds In Use",
    subtitle = "The numbers below are all 7-day averages"
  ) %>%
  fmt_percent(
    columns = vars(used_pct, cov_pct),
    decimals = 0
  ) %>%
  tab_source_note(
    source_note = "Source: https://healthdata.gov"
  ) %>%
  cols_label(hospital_name = "Hospital Name",
             city = "City",
             total = "Total ICU Beds",
             used_pct = "Percent In Use",
             cov_pct = "Percent COVID19")
```


### Cases - Indiana

```{r, echo=FALSE, fig.width=12, fig.height=5, message=FALSE, warning=FALSE}
ggplot(Indiana, aes(x = date, y = difconfirmed_per)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Indiana New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed",
              span = weekspan) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

### Percentage of Positive Tests

The percentage of tests coming back positive is one way to measure the prevalence of testing.

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning = FALSE}
ggplot(Indiana, aes(x = date, y = (difconfirmed / diftests))) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  coord_cartesian(ylim = c(0,.5)) +
  scale_y_continuous(oob = squish, labels = scales::percent) +
  ggtitle("Indiana Percentage of Positive Tests Each Day") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  geom_point(size = 4) +
  stat_smooth(linetype = "dashed", se = FALSE, span = weekspan) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

### Deaths - Indiana

```{r, echo=FALSE, fig.width=12, fig.height=5, message=FALSE, warning=FALSE}
ggplot(Indiana, aes(x = date, y = difdeaths_per)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Indiana New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

&nbsp;

# Kosciusko Data

&nbsp;

Note that the y-axis scales of these graphs are different than the state-level data.

### Cases - Kosciusko

```{r, echo=FALSE, fig.width=12, fig.height=5, message=FALSE, warning=FALSE}
ggplot(Kos, aes(x =  DATE, y = difconfirmed_per)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Kosciusko New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

### Deaths - Kosciusko

Note that if the number of deaths below is more than the official count according to Kosciusko county, that is most likely because our data source is also counting non-residents of Kosciusko county who have died in Koscisusko county.

```{r, echo=FALSE, fig.width=12, fig.height=5, message=FALSE, warning=FALSE}
ggplot(Kos, aes(x = DATE, y = difdeaths_per)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Kosciusko New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

&nbsp;

# Indiana Outbreaks

The coloring scheme for the map below is based on a combination of new cases per captita in the past week and positivity for unique indivuals in the previous week.  The coloring scheme is relative, it will always color the worst county pure red and the best county white.

```{r, echo=FALSE, fig.width=12, fig.height=14, warning=FALSE, message=FALSE}
#Compute the Index for the map coloring
Ind_trans <- Indices %>%
  select(PRIM_LONG_DEC, PRIM_LAT_DEC, key_numeric, COUNTY_NAME.x,
         combined, Case_per, POSITIVE_TEST_RATE_MOVING_AVG) %>%
  ungroup() %>%
  mutate(labels = str_glue("{COUNTY_NAME.x}", "\n",
                           "{round(Case_per,0)}", " & ",
                           "{round(POSITIVE_TEST_RATE_MOVING_AVG,0)}", "%",
                           sep = ""))
  
Ind_map <- usmap_transform(Ind_trans)

plot_usmap("counties",
           data = Indices, values = "combined", color = "blue",
           include = Indices$fips, labels = FALSE) + 
    ggplot2::scale_fill_continuous(low = "white", high = "red") + 
    theme(legend.position = "none") +
    geom_text(data = Ind_map,
              aes(x = PRIM_LONG_DEC.1,
                  y = PRIM_LAT_DEC.1,
                  label = labels))
```




Below are the six counties in Indiana with the worst combination of new confirmed cases and new confirmed deaths over the past week.

Note that the y-axis scales of these graphs are different than other sections.

### Cases - Outbreaks in Indiana

The first chart is a comparison of smoothed weighted averages. The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
ggplot(IN_outbreak, aes(x = DATE,
                     y = difconfirmed_per, color = county)) + 
  stat_smooth(size = 2, se = FALSE, span = 5/3*weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

The chart below does not contain two outliers for Cass County.  On April 26th, Cass County reported 271 new cases (575 per 80,000), and on April 27th, Cass County reported 439 new cases (932 per 80,000).

```{r echo=FALSE, fig.width=12, fig.height=5, message = FALSE, warning=FALSE}
ggplot(IN_outbreak, aes(x = DATE, y = difconfirmed_per, color = county)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
#Include if Cass is in  coord_cartesian(ylim = c(0,200)) +
  scale_y_continuous(oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  facet_wrap(vars(county), nrow = 3, ncol = 2) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```


### Deaths - Outbreaks in Indiana

The first chart is a comparison of smoothed weighted averages. The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
ggplot(IN_outbreak, aes(x = DATE,
                     y = difdeaths_per, color = county)) + 
  stat_smooth(size = 2, se = FALSE, span = 5/3*weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning = FALSE}
#Plot Deaths per Million per Day
ggplot(IN_outbreak, aes(x = DATE, y = difdeaths_per, color = county)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  facet_wrap(vars(county), nrow = 3, ncol = 2) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

&nbsp;

# Neighboring Counties

&nbsp;

Note that the y-axis scales of these graphs are different than other sections.

### Cases - Counties Neighboring Kosciusko

The first chart is a comparison of smoothed weighted averages.  The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
KOS_plus <- rbind(KOS_neighbors, Kos)
KOS_plus$county <- droplevels(factor(KOS_plus$county))
n = length(KOS_neighbor_counties)
m = match("Kosciusko", levels(KOS_plus$county)) - 1
c_vals = append(gg_color_hue(n), "black", after = m)
names(c_vals) <- levels(KOS_plus$county)
ggplot(KOS_plus, aes(x = DATE,
                     y = difconfirmed_per, color = county)) + 
  stat_smooth(size = 2, se = FALSE, span = 5/3*weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") + 
  scale_color_manual(values = c_vals) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

```{r, echo=FALSE, fig.width=12, fig.height=8, warning=FALSE, message=FALSE}
#Plot Confirmed per Million per Day
#breaks <- 10^(-10:10)
#minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))
ggplot(KOS_neighbors, aes(x = DATE, y = difconfirmed_per, color = county)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  facet_wrap(vars(county), nrow = 6, ncol = 2) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```


&nbsp;

### Deaths - Counties Neighboring Kosciusko

The first chart is a comparison of smoothed weighted averages.  The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
ggplot(KOS_plus, aes(x = DATE,
                     y = difdeaths_per, color = county)) + 
  stat_smooth(size = 2, se = FALSE, span = 5/3*weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") + 
  scale_color_manual(values = c_vals) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

```{r, echo=FALSE, fig.width=12, fig.height=8, warning=FALSE, message=FALSE}
#Plot Confirmed per Million per Day
#breaks <- 10^(-10:10)
#minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))
ggplot(KOS_neighbors, aes(x = DATE, y = difdeaths_per, color = county)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(hjust = 0.5), legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths", per_word, "People")) + 
  xlab("Date") +
  facet_wrap(vars(county), nrow = 6, ncol = 2) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```


&nbsp;

# Neighboring States Data

&nbsp;

Note that the y-axis scales of these graphs are different than other sections.

### Cases - States Neighboring Indiana

The first plot is a comparison of smoothed weighted averages.  The second is the actual data.

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
IN_and_neighbors <- rbind(IN_neighbors, Indiana)
ggplot(IN_and_neighbors, aes(x = date, y = difconfirmed_per, color = administrative_area_level_2)) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Cases per Day per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Cases per Day per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_color_manual(values = c("Indiana" = "black", "Michigan" = "#00BFC4", "Illinois" = "#F8766D", "Ohio" = "#C77CFF", "Kentucky" = "#7CAE00")) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

```{r, echo=FALSE, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
ggplot(IN_neighbors, aes(x = date, y = difconfirmed_per, color = administrative_area_level_2)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Cases per Day per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Cases per Day per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(administrative_area_level_2), nrow = 3, ncol = 2) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

&nbsp;

### Hospitalizations - States Neighboring Indiana

Because hospitalizations are smoother than cases or deaths, we present the data with line graphs below:

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
ggplot(IN_and_neighbors, aes(x = date,
                     y = hosp_per, color = administrative_area_level_2)) + 
  #stat_smooth(size = 2, se = FALSE, span = weekspan) +
  geom_line(size = 2) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(1,NA)) +
  ggtitle(paste("Outbreaks - Hospitalizations per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Hospitalizations per", per_word, "People")) + 
  xlab("Date") +
  scale_color_manual(values = c("Indiana" = "black", "Michigan" = "#00BFC4", "Illinois" = "#F8766D", "Ohio" = "#C77CFF", "Kentucky" = "#7CAE00")) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```


### Deaths - States Neighboring Indiana

The first plot is a comparison of smoothed weighted averages.  The second is the actual data.

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
ggplot(IN_and_neighbors, aes(x = date, y = difdeaths_per, color = administrative_area_level_2)) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Deaths per Day per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Deaths per Day per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_color_manual(values = c("Indiana" = "black", "Michigan" = "#00BFC4", "Illinois" = "#F8766D", "Ohio" = "#C77CFF", "Kentucky" = "#7CAE00")) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

```{r, echo=FALSE, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
ggplot(IN_neighbors, aes(x = date, y = difdeaths_per, color = administrative_area_level_2)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("New Confirmed Deaths per Day per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Deaths per Day per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(administrative_area_level_2), nrow = 3, ncol = 2) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```


### Positive Test Rate - States Neighboring Indiana

Looking at the percentage of tests that come back positive can signal which states might have low case numbers because of lack of testing.

For example, Michigan had a much higher death rate per capita than Illinois in mid-April, even though their case numbers per capita were only a little higher in late March and early April.  Michigan's high postive test rate late March and early April suggests that Michigan had worse testing than Illinois during that time.

The first plot is a comparison of smoothed weighted averages.  The second is the actual data.

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning = FALSE}
#Plot Deaths per Million per Day
ggplot(IN_and_neighbors, aes(x = date, y = (difconfirmed / diftests), color = administrative_area_level_2)) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  coord_cartesian(ylim = c(0,.5)) +
  scale_y_continuous(limit=c(0,NA),
                     oob = squish,
                     labels = scales::percent) +
  ggtitle("Percentage of Positive Tests Each Day") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_color_manual(values = c("Indiana" = "black", "Michigan" = "#00BFC4", "Illinois" = "#F8766D", "Ohio" = "#C77CFF", "Kentucky" = "#7CAE00")) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

Warning: the plots below contain several outliers where 

```{r, echo=FALSE, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
#Plot Deaths per Million per Day
ggplot(IN_neighbors, aes(x = date, y = (difconfirmed / diftests), color = administrative_area_level_2)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  coord_cartesian(ylim = c(0,.5)) +
  scale_y_continuous(limit=c(0,NA),
                     oob = squish,
                     labels = scales::percent) +
  ggtitle("Percentage of Positive Tests Each Day") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Percent Positive", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(administrative_area_level_2), nrow = 3, ncol = 2) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

&nbsp;

# US outbreaks by state

The coloring scheme for the map below is based on a combination of average hospitalizations and new deaths per captita in the past week.  The coloring scheme is relative, it will always color the worst state pure red.

```{r, echo=FALSE, fig.width=12, fig.height=14, warning=FALSE, message=FALSE}
US_states$state <- US_states$administrative_area_level_2
US7 <- US_states[US_states$date <= yest & US_states$date > (yest - 7),]
US_Indices <- aggregate(cbind(hosp_per, difdeaths_per) ~ state, data = US7, FUN = sum)
US_Indices$hosp_index <- US_Indices$hosp_per/sum(US_Indices$hosp_per)
US_Indices$death_index <- US_Indices$difdeaths_per/sum(US_Indices$difdeaths_per)
US_Indices$combined <- sqrt(3*US_Indices$hosp_index^2 + US_Indices$death_index^2)
plot_usmap("states",
           data = US_Indices, values = "combined", color = "blue",
           include = US_Indices$fips, labels = TRUE) + 
    scale_fill_continuous(name = "Outbreak Index",
                          low = "white", high = "red") + 
    theme(legend.position = "right")
```
&nbsp;

### Cases - Outbreaks in US

The first chart is a comparison of smoothed weighted averages. The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
US_Indices <- US_Indices[order(-US_Indices$combined),]
outbreaks <- US_Indices$state[1:6]
US_outbreak <- subset(US_states, state %in% outbreaks)
ggplot(US_outbreak, aes(x = date,
                     y = difconfirmed_per, color = state)) + 
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning = FALSE}
ggplot(US_outbreak, aes(x = date, y = difconfirmed_per, color = state)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Cases per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Cases per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(state), nrow = 3, ncol = 2) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

&nbsp;

### Hospitalizations - Outbreaks in US

Because hospitalizations are smoother than cases or deaths, we present the data with line graphs below:

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
ggplot(US_outbreak, aes(x = date,
                     y = hosp_per, color = state)) + 
  #stat_smooth(size = 2, se = FALSE, span = weekspan) +
  geom_line(size = 2) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
#  scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) + 
  scale_y_continuous(limit=c(1,NA)) +
  ggtitle(paste("Outbreaks - Hospitalizations per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("Hospitalizations per", per_word, "People")) + 
  xlab("Date") +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

&nbsp;

&nbsp;

### Deaths - Outbreaks in US

The first chart is a comparison of smoothed weighted averages. The second chart is the actual data.

```{r, echo=FALSE, fig.width=12, fig.height=5, warning=FALSE, message=FALSE}
ggplot(US_outbreak, aes(x = date,
                     y = difdeaths_per, color = state)) + 
  stat_smooth(size = 2, se = FALSE, span = weekspan) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA)) +
  ggtitle(paste("Outbreaks - New Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```

```{r, echo=FALSE, fig.width = 12, fig.height = 5, message=FALSE, warning = FALSE}
ggplot(US_outbreak, aes(x = date, y = difdeaths_per, color = state)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  ="1 month",
               minor_breaks = "1 day") + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle(paste("Outbreaks - New Confirmed Deaths per", per_word, "People")) + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab(paste("New Deaths per", per_word, "People")) + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = weekspan) +
  facet_wrap(vars(state), nrow = 3, ncol = 2) +
  geom_vline(xintercept =  seq(as.Date("2020/4/1"), yest, "months"))
```


```{r, echo=FALSE, fig.width=12, fig.height=14, warning=FALSE, message=FALSE, warning=FALSE, results='hide', eval=FALSE}
# US outbreaks by county

#The coloring scheme for the map below is based on a combination of new confirmed cases per capita and new deaths per captita in the past week.  The coloring scheme is relative, it will always color the worst county pure red.

US_counties$difdeaths <- prepend(diff(US_counties$deaths), 0)
US_counties$difconfirmed <- prepend(diff(US_counties$confirmed), 0)
US_counties$diftests <- prepend(diff(US_counties$tests), 0)
US_counties$difconfirmed_per <- US_counties$difconfirmed / US_counties$population * per
US_counties$difdeaths_per <- US_counties$difdeaths / US_counties$population * per
US_counties$diftests_per <- US_counties$diftests / US_counties$population * per
US7c <- US_counties[US_counties$date <= yest & US_counties$date > (yest - 7),]
US7c$county <- factor(US7c$administrative_area_level_3)
US7c$state <- factor(US7c$administrative_area_level_2)
USc_Indices <- aggregate(cbind(difconfirmed_per, difdeaths_per) ~ state + county + key_numeric, data = US7c, FUN = sum)

#Fix errors
# <- subset(USc_Indices, USc_Indices$county != "Out of GA")
#USc_Indices <- subset(USc_Indices, USc_Indices$county != "Out of TN")
#USc_Indices <- subset(USc_Indices, USc_Indices$county != "Kansas City")
#USc_Indices <- subset(USc_Indices, USc_Indices$county != "New York City")
#USc_Indices <- subset(USc_Indices, USc_Indices$county != "City of Joplin")
#USc_Indices <- subset(USc_Indices, USc_Indices$state != "Alaska")
#VAc <- counties("Virginia", cb = TRUE)
#VAC <- data.frame("county" = VAc$NAME, "FIP" = VAc$COUNTYFP)
#VAC <- subset(VAC, FIP < 200)
#USc_Indices <- subset(USc_Indices, USc_Indices$state != "Virginia" | USc_Indices$county %in% VAC$county)
#USc_Indices$county <- as.character(USc_Indices$county)
#USc_Indices[USc_Indices$state == "Louisiana",]$county <- paste(USc_Indices[USc_Indices$state == "Louisiana",]$county, "Parish")
#USc_Indices[USc_Indices$state == "Louisiana" & USc_Indices$county == "LaSalle Parish",]$county <- "La Salle Parish"
#USc_Indices$county <- as.factor(USc_Indices$county)


USc_Indices$confirmed_index <- USc_Indices$difconfirmed_per/sum(USc_Indices$difconfirmed_per)
USc_Indices$death_index <- USc_Indices$difdeaths_per/sum(USc_Indices$difdeaths_per)
USc_Indices$combined <- (2*USc_Indices$confirmed_index^2 + USc_Indices$death_index^2)^(1/5)

USc_Indices$fips <- USc_Indices$key_numeric
USc_Indices$fips <- as.character(USc_Indices$fips)
USc_Indices$fips <- paste0("0", USc_Indices$fips)
USc_Indices$fips <- substr(USc_Indices$fips, nchar(USc_Indices$fips)-4, nchar(USc_Indices$fips))

#USc_Indices$fips <- NA
#for (state in c("Alabama", levels(US7c$state)[3:51])){
#     USc_Indices[USc_Indices$state == state,]$fips <- fips(state = state, county = USc_Indices[USc_Indices$state == state,]$county)
#}

states <- plot_usmap("states", color = "black", fill = alpha(0.01))
counties <- plot_usmap(data = USc_Indices,
                       values = "combined",
                       include = USc_Indices$fips,
                       color = "black",
                       size = 0.1)
ggplot() +
  counties$layers[[1]] + #counties needs to be on top of states for this to work
  states$layers[[1]] +
  counties$theme + 
  coord_equal() +
  theme(legend.position="none") +
  scale_fill_gradient(low='white', high='red')
```

Data Sources: