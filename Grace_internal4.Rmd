---
header-includes:
- \usepackage{pdflscape}
- \usepackage{booktabs}
- \usepackage{xcolor} 
- \usepackage{colortbl}
- \usepackage{graphicx}
always_allow_html: true
output:
  pdf_document:
    keep_tex: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.width = 12,
                      fig.height = 2,
                      results = "markdown")
```

```{r the_work}
library(tidyverse)
library(readxl)
library(scales)
library(zoo)
library(usmap)
library(kableExtra)
library(lubridate)

#Load Student and Employee Data
load("S.Rdata")
load("E.Rdata")
load("IN.Rdata")
load("I.Rdata")

K <- subset(IN_counties, IN_counties$COUNTY_NAME == "Kosciusko")

#The first day of data
fall <- as.Date("2020-07-20")
spring <- as.Date("2021-01-01")
#yest <- as.Date("2021-01-15")# 
yest <- Sys.Date()-1
last <- as.Date("2021-05-14")

S_all <- S %>%
  #Determine Home or Grace
  mutate(Location2 = factor(case_when(
    tolower(substring(Location, 1, 4)) == "home" ~ "Home",
    tolower(substring(Location, 1, 4)) == "off " ~ "Home",
    tolower(substring(Location, 1, 4)) == "fami" ~ "Home",
    TRUE ~ "Grace"),
    levels = c("Home", "Grace"))) %>%
  #Fix different ways of entering positives and negatives
  mutate(Test_Result = factor(tolower(substring(Test_Result, 1, 1)))) %>%
  #Fix positives that are not marked as isolated yet
  mutate(Isolated = case_when(
    Test_Result == "p" & is.na(Isolated) & !is.na(Quarantine) ~ Quarantine,
    Test_Result == "p" & is.na(Isolated) & !is.na(Test_Date) ~ Test_Date,
    Test_Result == "p" & is.na(Isolated) & !is.na(Result_Date) ~ Result_Date,
    TRUE ~ Isolated
  ))%>%
  #Filter only spring cases
  filter(pmax(Quarantine, Isolated, TQS, Result_Date, na.rm = TRUE) > fall,
         pmin(Quarantine, Isolated, TQS, Result_Date, na.rm = TRUE) <= yest) %>%
  #Mark TQS as quarantine
  mutate(Q_type = factor(case_when(
    !is.na(TQS) ~ "travel",
    !is.na(Quarantine) ~ "exposure",
    TRUE ~ as.character(NA)
  ), levels = c("travel", "exposure")),
  Quarantine = pmax(TQS, Quarantine, na.rm = TRUE))%>%
  #Add end dates when missing
  mutate(End_Date = case_when(
    is.na(End_Date) | is.na(Complete) ~ min(max(Quarantine, Isolated, Result_Date,
                          Test_Date, na.rm = TRUE) + 14, yest),
    End_Date > yest ~ yest,
    TRUE ~ End_Date
  )) %>%
  mutate(location = factor(case_when(
    Q_type == "travel" ~ "Grace_travel",
    Location2 == "Home" ~ "Home",
    TRUE ~ "Grace"
  ), levels = c("Grace", "Grace_travel", "Home")))

S_spring <- S_all %>%
  filter(pmax(Quarantine, Isolated, TQS, na.rm = TRUE) > spring)


E_all <- E %>%
  #Fix missing end dates for E if a return to work date exists
  mutate(End_Date = case_when(
    is.na(End_Date) & !is.na(Return_Date) ~ Return_Date,
    TRUE ~ End_Date
  )) %>%
  #Fix different ways of entering positives and negatives
  mutate(Test_Result = tolower(substring(E$Test_Result, 1, 1))) %>%
  #Don't count quarantines that are dated after isolation
  mutate(Quarantine = case_when(
    !is.na(Quarantine) & !is.na(Isolated) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine
  )) %>%
  mutate(End_Date = case_when(
    is.na(End_Date) | is.na(Complete) ~ min(max(Quarantine, Isolated, Result_Date,
                          Test_Date, na.rm = TRUE) + 14, yest),
    End_Date > yest ~ yest,
    TRUE ~ End_Date
  )) %>%
  mutate(Isolated = case_when(
    Test_Result == "p" & is.na(Isolated) & !is.na(Quarantine) ~ Quarantine,
    Test_Result == "p" & is.na(Isolated) & !is.na(Test_Date) ~ Test_Date,
    Test_Result == "p" & is.na(Isolated) & !is.na(Result_Date) ~ Result_Date,
    TRUE ~ Isolated
  ))%>%
  filter(pmin(Quarantine, Isolated, Result_Date, na.rm = TRUE) <= yest)

E_spring <- E_all %>%
  filter(pmax(Quarantine, Isolated, Test_Date, Result_Date, na.rm = TRUE) > spring)

##############################################################################
#Student Quarantine

#Fill in dates between start of student quarantine and end date
QS <- S_spring %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated > Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(ID:First_Name, location, Quarantine, End_Date)

#Then total for each day
QS_days_fill <- QS %>%
  rowwise() %>%
  do(data.frame(.[1:4], Quarantine = seq(.$Quarantine, .$End_Date, by = "1 day")))

#Note to self: the code paragraph below was for an atempt to create a spreadsheet detailing numbers.
#However, I see no need to pursue that any further. -Ryan 1/15/21
QS_by_day <- QS_days_fill %>%
  group_by(Quarantine, location, .drop = FALSE) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n)%>%
  mutate(S_Total_Quar = Grace + Home + Grace_travel) %>%
  ungroup() %>%
  rename(Date = Quarantine, S_Quar_Grace = Grace, S_Quar_Home = Home, S_Quar_Travel = Grace_travel)

QS_yest <- QS_by_day %>%
  filter(Date == yest) %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  rename(Grace = S_Quar_Grace, Home = S_Quar_Home, Grace_travel = S_Quar_Travel, Total = S_Total_Quar) %>%
  select(Type, Total, Home, Grace, Grace_travel)

QS_spring_total <- QS %>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home + Grace_travel) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Total, Home, Grace, Grace_travel)

QS_all_total <- S_all %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated > Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(ID:First_Name, location, Quarantine, End_Date) %>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home + Grace_travel) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Total, Home, Grace, Grace_travel)

QS_all_unique <- S_all %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated > Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(ID:First_Name, location, Quarantine, End_Date) %>%
  distinct(First_Name, Last_Name, location, .keep_all = TRUE)%>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home + Grace_travel) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Unique Students") %>%
  select(Type, Total, Home, Grace, Grace_travel)

QS_Tab <- bind_rows(QS_yest, QS_spring_total, QS_all_total, QS_all_unique)


#Maximum count needed for graphs
mQS <- QS_days_fill %>%
  group_by(Quarantine, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

##############################################################################
#Student Isolation Numbers

IS <- S_spring %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(ID:First_Name, location, Isolated, End_Date)

IS_days_fill <- IS%>%
  #DELETE THIS ROW ONCE DATA EXISTS
  add_row(Isolated = yest, End_Date = yest+1)%>%
  rowwise() %>%
  do(data.frame(.[1:4], Isolated = seq(.$Isolated, .$End_Date, by = "1 day")))

IS_yest <- IS_days_fill %>%
  filter(Isolated == yest) %>%
  mutate(location = factor(location,
                            levels = c("Grace", "Home")))%>%
  group_by(Isolated, location, .drop = FALSE)%>%
  summarise(n = n())%>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Total, Grace, Home)

IS_spring_total <- IS %>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Total, Grace, Home)

IS_all_total <- S_all %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(ID:First_Name, location, Isolated, End_Date)%>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Total, Grace, Home)

IS_all_unique <- S_all %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(ID:First_Name, location, Isolated, End_Date)%>%
  distinct(First_Name, Last_Name, .keep_all = TRUE)%>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Unique Students") %>%
  select(Type, Total, Grace, Home)

IS_Tab <- bind_rows(IS_yest, IS_spring_total, IS_all_total, IS_all_unique)

#Maximum count needed for graphs
mIS <- IS_days_fill %>%
  group_by(Isolated, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

#########################################################################
#Student Cases

#Fill in dates between start of student quarantine and end date,
#Then total for each day
CS <- S_spring %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Result Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  select(ID:First_Name, location, Test_Date, End_Date)

CS_days_fill <- CS %>%
  #DELETE THE LINE BELOW ONCE ISOLATED DATA EXISTS
  add_row(ID = NA, First_Name = NA, Last_Name = NA, location = NA, Test_Date = (yest), End_Date = (yest+1)) %>%
  rowwise() %>%
  do(data.frame(.[1:5], Test_Date = seq(.$Test_Date, .$End_Date, by = "1 day")))

CS_yest <- CS_days_fill %>%
  filter(Test_Date == yest) %>%
  group_by(Test_Date, location, .drop = FALSE) %>%
  summarise(n = n())%>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Total, Grace, Home)

CS_spring_total <- CS %>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Total, Grace, Home)

CS_all_total <- S_all %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Test Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  select(ID:First_Name, location, Test_Date, End_Date)%>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Total, Grace, Home)

CS_Tab <- bind_rows(CS_yest, CS_spring_total, CS_all_total)

#Maximum count needed for graphs
mCS <- CS_days_fill %>%
  group_by(Test_Date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n


################################################################################
#Employee Data

#Quarantine
#Fill in dates between start of student quarantine and end date
QE <- E_spring %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated >= Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(Last_Name:First_Name, Quarantine, End_Date)

#Then total for each day
QE_days_fill <- QE %>%
  rename(Date = Quarantine) %>%
  rowwise() %>%
  do(data.frame(.[1:2], Date = seq(.$Date, .$End_Date, by = "1 day"))) %>%
  tibble()

QE_yest <- QE_days_fill %>%
  #The line below is to create bogus data so that the summarization works
  add_row(Last_Name = NA, First_Name = NA, Date = yest) %>%
  filter(Date == yest) %>%
  group_by(Date, .drop = FALSE) %>%
  summarise(Quarantine = n()) %>%
  ungroup() %>%
  mutate(Quarantine = Quarantine-1) %>% #Correct for the bogus data
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Quarantine)

QE_spring_total <- QE %>%
  summarise(Quarantine = n()) %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Quarantine)

QE_all_total <- E_all %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated > Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(Last_Name:First_Name, Quarantine, End_Date) %>%
  summarise(Quarantine = n()) %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Quarantine)

QE_Tab <- bind_rows(QE_yest, QE_spring_total, QE_all_total)


#Maximum count needed for graphs
mQE <- QE_days_fill %>%
  group_by(Date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

############################################################################
#Employee Isolation Numbers

IE <- E_spring %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(Last_Name:First_Name, Isolated, End_Date)

IE_days_fill <- IE%>%
  rowwise() %>%
  do(data.frame(.[1:2], Date = seq(.$Isolated, .$End_Date, by = "1 day"))) %>%
  tibble()

IE_yest <- IE_days_fill %>%
  #The line below is to create bogus data so that the summarization works
  add_row(Last_Name = NA, First_Name = NA, Date = yest) %>%
  filter(Date == yest) %>%
  group_by(Date, .drop = FALSE) %>%
  summarise(Isolated = n()) %>%
  ungroup() %>%
  mutate(Isolated = Isolated-1) %>% #Correct for the bogus data
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Isolated)

IE_spring_total <- IE %>%
  summarise(Isolated = n()) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Isolated)

IE_all_total <- E_all %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(Last_Name:First_Name, Isolated, End_Date)%>%
  summarise(Isolated = n()) %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Isolated)

IE_Tab <- bind_rows(IE_yest, IE_spring_total, IE_all_total)

#Maximum count needed for graphs
mIE <- IE_days_fill %>%
  group_by(Date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

#########################################################################
#Employee Cases

#Fill in dates between start of student quarantine and end date,
#Then total for each day
CE <- E_spring %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Result Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  select(Last_Name:First_Name, Test_Date, End_Date)

CE_days_fill <- CE %>%
  rowwise() %>%
  do(data.frame(.[1:2], Test_Date = seq(.$Test_Date, .$End_Date, by = "1 day"))) %>%
  tibble()

CE_yest <- CE_days_fill %>%
  #The line below is to create bogus data so that the summarization works
  add_row(Last_Name = NA, First_Name = NA, Test_Date = yest) %>%
  filter(Test_Date == yest) %>%
  group_by(Test_Date, .drop = FALSE) %>%
  summarise(Cases = n()) %>%
  ungroup() %>%
  mutate(Cases = Cases-1) %>% #Correct for the bogus data
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Cases)

CE_spring_total <- CE %>%
  summarise(Cases = n()) %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Cases)

CE_all_total <- E_all %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Test Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  select(Last_Name:First_Name, Test_Date, End_Date)%>%
  summarise(Cases = n()) %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Cases)

CE_Tab <- bind_rows(CE_yest, CE_spring_total, CE_all_total)

#Maximum count needed for graphs
mCE <- CE_days_fill %>%
  group_by(Test_Date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

#########################################################################

#Colors used for graphs
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
c_vals = gg_color_hue(3)
names(c_vals) <- rev(levels(S_all$location))

```

![Grace Logo](Logo-GC-Red-Background-Stretched.jpg)\

<center>
# Grace College Internal COVID-19 Data
## Compiled by Dr. Ryan Johnson using contact tracing data from Laura Green and Nicole Gibson, as well as testing data from the state of Indiana.
### Last updated `r format(Sys.time(), '%A, %B %d, %Y, at %I:%M%p')`
</center>

\vspace{2 in}

Notes and Irregularities:

  - This report assumes that any student or employee that has not been marked "complete" on the contact tracing spreadsheet is active for 2 weeks, and thus it may undercount active cases that last more than two weeks and overcount active cases when contact tracers fall behind completing cases.  Each case will be automatically corrected once it has been completed and is no longer active.

\newpage

# Cases


### Confirmed Cases Among Students

```{r student_cases_table}
CS_Tab %>%
  select(Type, Total, Home, Grace)%>%
  kbl(caption = "Student Cases", booktabs = TRUE, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```



```{r student_cases_vis, eval=FALSE}
adjust = 1
CS_days_fill %>%
  ggplot(aes(x = Test_Date, fill = location)) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 0.75,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    scale_fill_manual(values = c_vals) +
    # Make this as high as the tallest column
    coord_fixed(ratio = max(mCS,5)) +
    ggtitle("Active Confirmed Cases Among Students Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Students") + 
    xlab("Date")+
    geom_hline(yintercept =  seq(0, mCS, 10)/mCS, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))#+
#    annotate("text", x = spring+2,
#             y = seq(11, mCS, 10)/cf, label = seq(10, mCS, 10))
```

### Confirmed Cases Among Employees

```{r employee_cases_table}
CE_Tab %>%
  kable(caption = "Employee Cases",
        booktabs = T,
        format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```

```{r employee_cases_vis}
adjust = 1
CE_days_fill %>%
  ggplot(aes(x = Test_Date, fill = "red")) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    # Make this as high as the tallest column
    coord_fixed(ratio = max(mCE,5)) +
    ggtitle("Active Confirmed Cases Among Employees Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Employees") + 
    xlab("Date") +
    theme(legend.position = "none")+
    geom_hline(yintercept =  seq(0, mCE, 10)/mCE, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))#+
#    annotate("text", x = spring+2,
#             y = seq(11, mCE, 10)/cf, label = seq(10, mCE, 10))
```

\newpage

# Isolated

### Isolated Students

```{r studend_isolations_table}
IS_Tab %>%
  select(Type, Total, Home, Grace) %>%
  kbl(caption = "Student Isolations",
        booktabs = T, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```


```{r student_isolations_vis, eval=FALSE}
adjust = 1
cf = max(mIS+2, 5)
IS_days_fill %>%
  ggplot(aes(x = Isolated, fill = location)) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1,
                 stackratio = 1) + #was adjust
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    scale_fill_manual(values = c_vals) +
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Isolated Students Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Students") + 
    xlab("Date")+
    geom_vline(xintercept =  seq(spring, last, "months"))#+
#    annotate("text", x = spring+2,
#             y = seq(11, mIS, 10)/cf, label = seq(10, mIS, 10))
```

### Isolated Employees

```{r, employee_isolations_table}
IE_Tab %>%
  kable(caption = "Employee Isolations",
        booktabs = T, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```

```{r employee_isolations_vis}
cf = max(mIE+2, 5)
IE_days_fill %>%
  ggplot(aes(x = Date, fill = "red")) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Isolated Employees Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Employees") + 
    xlab("Date") +
    theme(legend.position = "none") +
    geom_hline(yintercept =  seq(0, mIE, 10)/cf, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))#+
#    annotate("text", x = spring+2,
#             y = seq(11, mIE, 10)/cf, label = seq(10, mIE, 10))
```

\newpage

# Quarantined

### Quarantined Students

In the table and graph below, `Grace_travel` are quarentines from international travel, and are not counted among the category `Grace`.  This is because they are quarantining because of travel, not exposure.

```{r student_quarantines_table}
QS_Tab %>%
  select(Type, Total, Home, Grace, Grace_travel) %>%
  kable(caption = "Student Quarantines",
        booktabs = T, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```



```{r student_quarantines_vis, fig.height=4}
adjust = 1
cf = max(mQS, 5)
QS_days_fill %>%
  ggplot(aes(x = Quarantine, fill = location)) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  ="7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    scale_fill_manual(values = c_vals) +
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Quarantined Students Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15),
          legend.position="bottom") + 
    ylab("Students") + 
    xlab("Date") +
    geom_hline(yintercept =  seq(0, mQS, 10)/cf, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))+
    annotate("text", x = spring+2,
             y = seq(11, mQS, 10)/cf, label = seq(10, mQS, 10))
```

### Quarantined Employees

```{r employee_quarantines_table}
QE_Tab %>%
  kable(caption = "Employee Quarantines",
        booktabs = T, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```

```{r employee_quarantines_vis}
adjust = 1
cf = max(mQE+2, 5)
QE_days_fill %>%
  ggplot(aes(x = Date, fill = "red")) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Quarantined Employees Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Employees") + 
    xlab("Date") +
    theme(legend.position = "none") +
    geom_hline(yintercept =  seq(0, mQE, 10)/cf, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))#+
 #   annotate("text", x = first,
 #            y = seq(1, mQE+1, 10)/cf, label = seq(0, mQE, 10))
```


\newpage


```{r state_and_county, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
#Input parameters
cfirst = floor_date(yest-90, unit = "month")
clast = ceiling_date(yest, unit = "month")

K$CC7 <- c(rep(0,6), rollmean(K$COVID_COUNT, 7))
K$CT7 <- c(rep(0,6), rollmean(K$COVID_TESTS_ADMINISTRATED, 7))
K$CCT <- c(rep(0,4), rollsum(K$COVID_COUNT, 7), rep(0,2))
K$CTT <- c(rep(0,6), rollsum(K$COVID_TESTS_ADMINISTRATED, 7))

nK2 = nrow(K)
K$TEST_RATE <- K$CCT / K$CTT
K$TEST_RATE <- c(rep(NA, 3), K$TEST_RATE[seq(-nK2, length.out = 3)])

K <- subset(K, DATE > cfirst)
nK = nrow(K)

I$CC7 <- c(rep(0,6), rollmean(I$COVID_COUNT, 7))
I$CT7 <- c(rep(0,6), rollmean(I$COVID_TEST, 7))
I$CCT <- c(rep(0,4), rollsum(I$COVID_COUNT, 7), c(rep(0,2)))
I$CTT <- c(rep(0,6), rollsum(I$COVID_TEST, 7))

nI2 = nrow(I)
I$TEST_RATE <- I$CC7 / I$CT7
I$TEST_RATE <- c(rep(NA, 3), I$TEST_RATE[seq(-nI2, length.out = 3)])

I <- subset(I, DATE > cfirst)
nI = nrow(I)

weekspan <- 3*7/(as.numeric(clast) - as.numeric(cfirst)+2)
```

\newpage

# Kosciusko County
Kosciusko County has had

* `r K$COVID_COUNT_MOVING_AVG[[nK]]` cases per day the past week.
* `r sum(K$COVID_COUNT)` total confirmed cases.

### Cases - Kosciusko

```{r K_cases, fig.height=5}
ggplot(K, aes(x = DATE, y = COVID_COUNT)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle("Kosciusko New Confirmed Cases") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("New Cases") + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(cfirst, clast, "months"))
```

### Positivity - Kosciusko

Kosciusko County has had `r subset(K, DATE == yest - 7)$POSITIVE_TEST_RATE_MOVING_AVG`% 7-day positivity rate for unique indiviudals as of `r format(yest-7, "%B %d")`.



```{r K_pos, fig.height=5}
ggplot(subset(K, DATE < yest - 6), aes(x = DATE, y = POSITIVE_TEST_RATE_MOVING_AVG/100)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     limit=c(0,NA)) +
  ggtitle("Kosciusko Percentage of Positive Tests - 7 Day Rolling Average") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  geom_vline(xintercept =  seq(cfirst, clast, "months")) +
  geom_hline(yintercept = 0)
#* `r round(100 * K$TEST_RATE[[nK-5]], digits = 1)`% 7-day positivity rate as of `r format(yest-5, "%B %d")`.  This number is computed assuming an average 2-day wait for test results, and might not fit exactly with the positivity rate on the state's dashboard.
#* `r round(100 * K$TEST_RATE[[nK-5]], digits = 1)`% = `r K$CCT[[nK-8]]` / `r K$CTT[[nK-8]]`.
```

\newpage

# Indiana

The total case numbers below are multiplied by $\frac{\text{Kos pop}}{\text{Ind pop}} = \frac{79456}{6732000} = 0.01180273$, so that it is easier to compare Kosciusko numbers to the average Indiana county.

Indiana has had

* `r round(I$CC7[[nI]], digits = 1)` cases per day the past week (normalized `r round(I$CC7[[nI]]*79456/6732000, digits = 1)`).
* `r prettyNum(sum(I$COVID_COUNT),big.mark=",",scientific=FALSE)` total confirmed cases (normalized `r round(sum(I$COVID_COUNT)*79456/6732000, digits = 1)`).

### Cases - Indiana

```{r I_cases, fig.height=5}
ggplot(I, aes(x = DATE, y = COVID_COUNT * 79456/6732000)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle("Normalized Indiana New Confirmed Cases") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Normalized New Cases") + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(cfirst, clast, "months"))
```

### Positivity - Indiana

Indiana reports a `r round(subset(I, DATE == yest - 7)$POSITIVITY_RATE_ALL_TESTS, 1)`% 7-day positivity rate for all tests as of `r format(yest-7, "%B %d")`.

```{r I_pos, fig.height=5}
ggplot(subset(I, DATE <= yest - 7), aes(x = DATE, y = POSITIVITY_RATE_ALL_TESTS/100)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     limit=c(0,NA)) +
  ggtitle("Indiana Average Positivity Rate for All Tests") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(cfirst, clast, "months"))

#* `r round(100 * I$TEST_RATE[[nI-5]], digits = 1)`% 7-day positivity rate as of `r format(yest-6, "%B %d")`.  This number is computed assuming an average 2-day wait for test results, and might not fit exactly with the positivity rate on the state's dashboard.
#* `r round(100 * I$TEST_RATE[[nI-5]], digits = 1)`% = `r prettyNum(I$CCT[[nI-8]],big.mark=",",scientific=FALSE)` / `r prettyNum(I$CTT[[nI-8]], ,big.mark=",",scientific=FALSE)`.
```

\newpage

# Indiana Map

The map below displays the cases per 100,000 per day averaged over the past week and the positivity rate for unique individuals averaged over the previous week.  The coloring scheme is relative, it colors the best county white and the worst county red.

```{r I_map, fig.width=12, fig.height=14}
lat_and_long <- read_excel("lat_and_long.xlsx")
lat_and_long$COUNTY_NUMERIC <- lat_and_long$COUNTY_NUMERIC + 18000
load("county_populations.RData")
county_data <- merge(x = pops, y = lat_and_long,
                     by.x = "key_numeric",
                     by.y = "COUNTY_NUMERIC")


counties_yest <- IN_counties[IN_counties$DATE == yest-7,]
counties_yest$COVID_COUNT_MOVING_AVG <- IN_counties[IN_counties$DATE == yest-1,]$COVID_COUNT_MOVING_AVG

Indices <- merge(x = counties_yest, y = county_data,
                 by.x = "LOCATION_ID",
                 by.y = "key_numeric")
Indices$Case_per <- Indices$COVID_COUNT_MOVING_AVG / Indices$population * 1000
Indices$case_index <- Indices$Case_per/sum(Indices$Case_per)
Indices$positivity_index <- Indices$POSITIVE_TEST_RATE_MOVING_AVG/sum(Indices$POSITIVE_TEST_RATE_MOVING_AVG)
Indices$combined <- sqrt(Indices$case_index * Indices$positivity_index)
Indices$dashboard <- Indices$Case_per/2 + Indices$POSITIVE_TEST_RATE_MOVING_AVG/10
Indices <- Indices[order(-Indices$combined),]
outbreaks <- Indices$county[1:6]

Indices$fips <- Indices$LOCATION_ID

Ind_trans <- subset(Indices, select = c(PRIM_LONG_DEC,
                                        PRIM_LAT_DEC,
                                        LOCATION_ID,
                                        COUNTY_NAME.x,
                                        combined,
                                        Case_per,
                                        POSITIVE_TEST_RATE_MOVING_AVG))
Ind_trans$labels <- paste0(Ind_trans$COUNTY_NAME.x, "\n",
                           round(100*Ind_trans$Case_per,0), " & ",
                           round(Ind_trans$POSITIVE_TEST_RATE_MOVING_AVG,0), "%")
Ind_map <- usmap_transform(Ind_trans)

plot_usmap("counties",
           data = Indices, values = "combined", color = "blue",
           include = Indices$fips, labels = FALSE) + 
    ggplot2::scale_fill_continuous(low = "white", high = "red") + 
    theme(legend.position = "none") +
    geom_text(data = Ind_map,
              aes(x = PRIM_LONG_DEC.1,
                  y = PRIM_LAT_DEC.1,
                  label = labels))
```

