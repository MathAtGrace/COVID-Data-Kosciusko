---
header-includes:
- \usepackage{pdflscape}
- \usepackage{booktabs}
- \usepackage{xcolor} 
- \usepackage{colortbl}
- \usepackage{graphicx}
always_allow_html: true
output:
  pdf_document:
    keep_tex: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.width = 12,
                      fig.height = 2,
                      results = "markdown")
```

```{r the_work}
library(tidyverse)
library(readxl)
library(scales)
library(zoo)
library(usmap)
library(kableExtra)
library(lubridate)
library(RcppRoll)
library(janitor)

#Load Student and Employee Data
load("SF.Rdata")
load("SS.Rdata")
load("E.Rdata")
load("IN.Rdata")
load("I.Rdata")
load("T.Rdata")

K <- subset(IN_counties, IN_counties$COUNTY_NAME == "Kosciusko")

#The first day of data
fall <- as.Date("2020-07-20")
spring <- as.Date("2021-01-01")
#yest <- as.Date("2021-01-24") #For redoing past reports
yest <- Sys.Date()-1
last <- as.Date("2021-05-15")

SS <- S_spring %>%
  clean_names() %>%#In case of emergency: unnest_longer(problem_column,indices_include = FALSE)
  select(id:first_name, quarantine_isolation_location:test_result,
         actual_release_from_quarantine_isolation,
         complete, positive_at_home) %>%
#  filter(is.na(positive_at_home)) %>%
  rename(location = quarantine_isolation_location,
         tqs = travel_quarantine_start_date,
         exposure = last_exposure_date,
         symptoms = symptom_start_date,
         started = quarantine_isolation_started,
         end_date = actual_release_from_quarantine_isolation,
         completed = complete) %>%
  mutate(tqs = convert_to_date(tqs),
         exposure = convert_to_date(exposure),
         symptoms = convert_to_date(symptoms),
         test_date = convert_to_date(test_date),
         end_date = convert_to_date(end_date),
         started = pmin(tqs, test_date, convert_to_date(started), na.rm = TRUE)) %>%
  mutate(test_result = tolower(substring(test_result, 1, 1))) %>%
  mutate(type = factor(case_when(
           test_result == "p" ~ "Isolation",
           !is.na(symptoms) ~ "Isolation",
           TRUE ~ "Quarantine"))) %>%
  mutate(started = case_when(
    is.na(started) & !is.na(exposure) ~ exposure,
    is.na(started) & test_result == "p" & !is.na(end_date) ~ end_date - 10,
    started > end_date ~ end_date,
    TRUE ~ started
  )) %>%
  filter(!is.na(started) & started <= yest) %>%
  mutate(end_date = case_when(
    is.na(end_date) | is.na(completed) ~ pmin(started + 14, yest),
    end_date > yest ~ yest,
    TRUE ~ end_date
  )) %>%
  mutate(location = factor(case_when(
    !is.na(tqs) & type != "Isolation" ~ "Grace_travel",
    !is.na(positive_at_home) ~ "Before",
    tolower(substring(location, 1, 4)) == "home" ~ "Home",
    tolower(substring(location, 1, 4)) == "off " ~ "Home",
    tolower(substring(location, 1, 4)) == "fami" ~ "Home",
    tolower(substring(location, 1, 4)) == "poss" ~ "Home",
    TRUE ~ "Grace"), levels = c("Before", "Home", "Grace_travel", "Grace"))) %>%
  select(id, first_name, last_name, location, type, test_result, test_date, started, end_date)

SF <- S_fall %>%
  clean_names() %>%
  select(id:first_name, location,
         travel_quarantine_start_date:nurse_approved_release_date_estimate_only_until_final,
         completed) %>%
  rename(tqs = travel_quarantine_start_date,
         exposure = last_exposure_date,
         q_started = quarantine_started,
         i_started = isolated_for_covid_19_symptoms_or_positive_test,
         symptoms = date_symptoms_started,
         end_date = nurse_approved_release_date_estimate_only_until_final,
         result_date = covid_19_positive_date)%>%
  mutate(tqs = convert_to_date(tqs),
         exposure = convert_to_date(exposure),
         q_started = convert_to_date(q_started),
         i_started = convert_to_date(i_started),
         symptoms = convert_to_date(symptoms),
         test_date = convert_to_date(test_date),
         result_date = convert_to_date(result_date),
         end_date = convert_to_date(end_date),
         test_result = factor(tolower(substring(test_result, 1, 1)))) %>%
  mutate(type = factor(case_when(
            test_result == "p" ~ "Isolation",
            !is.na(i_started) ~ "Isolation",
            TRUE ~ "Quarantine")),
         started = pmin(tqs, q_started, i_started, test_date, result_date, na.rm = TRUE)) %>%
  mutate(started = case_when(
    is.na(started) & !is.na(exposure) ~ exposure,
    TRUE ~ started
  )) %>%
  select(-q_started, -i_started) %>%
  mutate(started = case_when(
    is.na(started) & !is.na(end_date) & !is.na(exposure) & type == "Quarantine" ~ exposure,
    TRUE ~ started
  )) %>%
  filter(!is.na(started)) %>%
  mutate(end_date = case_when(
    is.na(end_date) | is.na(completed) ~ started + 14,
    TRUE ~ end_date
  )) %>%
  mutate(location = factor(case_when(
    !is.na(tqs) & type != "Isolation" ~ "Grace_travel",
    tolower(substring(location, 1, 4)) == "home" ~ "Home",
    tolower(substring(location, 1, 4)) == "off " ~ "Home",
    tolower(substring(location, 1, 4)) == "fami" ~ "Home",
    TRUE ~ "Grace"), levels = c("Home", "Grace_travel", "Grace"))) %>%
  select(id, first_name, last_name, location, type, test_result, test_date, started, end_date)

SS_days_fill <- SS %>%
  rowwise() %>%
  do(data.frame(.[1:6], date = seq(.$started, .$end_date, by = "1 day")))

S_all <- bind_rows(SS, SF)

E_all <- E %>%
  #Fix missing end dates for E if a return to work date exists
  mutate(End_Date = case_when(
    is.na(End_Date) & !is.na(Return_Date) ~ Return_Date,
    TRUE ~ End_Date
  )) %>%
  #Fix different ways of entering positives and negatives
  mutate(Test_Result = tolower(substring(E$Test_Result, 1, 1))) %>%
  #Don't count quarantines that are dated after isolation
  mutate(Quarantine = case_when(
    !is.na(Quarantine) & !is.na(Isolated) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine
  )) %>%
  mutate(End_Date = case_when(
    is.na(End_Date) | is.na(Complete) ~ min(max(Quarantine, Isolated, Result_Date,
                          Test_Date, na.rm = TRUE) + 14, yest),
    End_Date > yest ~ yest,
    TRUE ~ End_Date
  )) %>%
  mutate(Isolated = case_when(
    Test_Result == "p" & is.na(Isolated) & !is.na(Quarantine) ~ Quarantine,
    Test_Result == "p" & is.na(Isolated) & !is.na(Test_Date) ~ Test_Date,
    Test_Result == "p" & is.na(Isolated) & !is.na(Result_Date) ~ Result_Date,
    TRUE ~ Isolated
  ))%>%
  filter(pmin(Quarantine, Isolated, Result_Date, na.rm = TRUE) <= yest)

E_spring <- E_all %>%
  filter(pmax(Quarantine, Isolated, Test_Date, Result_Date, na.rm = TRUE) > spring)

##############################################################################
#Student Quarantine

#Note to self: the code paragraph below was for an atempt to create a spreadsheet detailing numbers.
#However, I see no need to pursue that any further. -Ryan 1/15/21
QS_by_day <- SS_days_fill %>%
  filter(type == "Quarantine") %>%
  group_by(date, location, .drop = FALSE) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n)%>%
  mutate(s_total_quar = Grace + Home) %>%
  ungroup() %>%
  rename(S_Quar_Grace = Grace, S_Quar_Home = Home, S_Quar_Travel = Grace_travel)

QS_yest <- QS_by_day %>%
  filter(date == yest) %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  rename(Grace = S_Quar_Grace, Home = S_Quar_Home, Grace_travel = S_Quar_Travel, Total = s_total_quar) %>%
  select(Type, Total, Home, Grace, Grace_travel)

QS_spring_total <- SS %>%
  filter(type == "Quarantine") %>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Total, Home, Grace, Grace_travel)

QS_all_total <- S_all %>%
  filter(type == "Quarantine") %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Total, Home, Grace, Grace_travel)

QS_all_unique <- S_all %>%
  filter(type == "Quarantine") %>%
  distinct(first_name, last_name, location, .keep_all = TRUE)%>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Unique Students") %>%
  select(Type, Total, Home, Grace, Grace_travel)

QS_Tab <- bind_rows(QS_yest, QS_spring_total, QS_all_total, QS_all_unique)


#Maximum count needed for graphs
mQS <- SS_days_fill %>%
  filter(type == "Quarantine", location != "Grace_travel") %>%
  group_by(date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

##############################################################################
#Student Isolation Numbers

IS_yest <- SS_days_fill %>%
  filter(type == "Isolation" & date == yest) %>%
  group_by(date, location, .drop = FALSE)%>%
  summarise(n = n())%>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Total, Grace, Home, Before)

IS_spring_total <- SS %>%
  filter(type == "Isolation") %>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Total, Grace, Home, Before)

IS_all_total <- S_all %>%
  filter(type == "Isolation") %>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Total, Grace, Home, Before)

IS_all_unique <- S_all %>%
  filter(type == "Isolation") %>%
  distinct(first_name, last_name, .keep_all = TRUE)%>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Unique Students") %>%
  select(Type, Total, Grace, Home, Before)

IS_Tab <- bind_rows(IS_yest, IS_spring_total, IS_all_total, IS_all_unique)

#Maximum count needed for graphs
mIS <- SS_days_fill %>%
  filter(type == "Isolation", location != "Before") %>%
  group_by(date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

#########################################################################
#Student Cases

#Fill in dates between start of student quarantine and end date,
#Then total for each day

CS_yest <- SS_days_fill %>%
  filter(test_result == "p", date == yest) %>%
  group_by(date, location, .drop = FALSE) %>%
  summarise(n = n())%>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Total, Grace, Home, Before)

CS_spring_total <- SS %>%
  filter(test_result == "p") %>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Total, Grace, Home, Before)

CS_all_total <- S_all %>%
  filter(test_result == "p") %>%
  group_by(location, .drop = FALSE)%>%
  summarise(n = n()) %>%
  pivot_wider(names_from = location, values_from = n) %>%
  mutate(Total = Grace + Home) %>%
  ungroup() %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Total, Grace, Home, Before)

CS_Tab <- bind_rows(CS_yest, CS_spring_total, CS_all_total)

#Maximum count needed for graphs
mCS <- SS_days_fill %>%
  filter(test_result == "p", location != "Before") %>%
  group_by(date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n


################################################################################
#Employee Data

#Quarantine
#Fill in dates between start of student quarantine and end date
QE <- E_spring %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated >= Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(Last_Name:First_Name, Quarantine, End_Date)

#Then total for each day
QE_days_fill <- QE %>%
  rename(Date = Quarantine) %>%
  rowwise() %>%
  do(data.frame(.[1:2], Date = seq(.$Date, .$End_Date, by = "1 day"))) %>%
  tibble()

QE_yest <- QE_days_fill %>%
  #The line below is to create bogus data so that the summarization works
  add_row(Last_Name = NA, First_Name = NA, Date = yest) %>%
  filter(Date == yest) %>%
  group_by(Date, .drop = FALSE) %>%
  summarise(Quarantine = n()) %>%
  ungroup() %>%
  mutate(Quarantine = Quarantine-1) %>% #Correct for the bogus data
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Quarantine)

QE_spring_total <- QE %>%
  summarise(Quarantine = n()) %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Quarantine)

QE_all_total <- E_all %>%
  filter(!is.na(Quarantine)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  mutate(End_Date = case_when(
    !is.na(Isolated) & (Isolated > Quarantine) ~ Isolated,
    TRUE ~ End_Date),
    Quarantine = case_when(
    !is.na(Isolated) & (abs(Quarantine - Isolated) < 10) & (Quarantine > Isolated) ~ as.Date(NA),
    TRUE ~ Quarantine)) %>%
  drop_na(Quarantine) %>%
  select(Last_Name:First_Name, Quarantine, End_Date) %>%
  summarise(Quarantine = n()) %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Quarantine)

QE_Tab <- bind_rows(QE_yest, QE_spring_total, QE_all_total)


#Maximum count needed for graphs
mQE <- QE_days_fill %>%
  group_by(Date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

############################################################################
#Employee Isolation Numbers

IE <- E_spring %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(Last_Name:First_Name, Isolated, End_Date)

IE_days_fill <- IE%>%
  rowwise() %>%
  do(data.frame(.[1:2], Date = seq(.$Isolated, .$End_Date, by = "1 day"))) %>%
  tibble()

IE_yest <- IE_days_fill %>%
  filter(Date == yest) %>%
  group_by(Date, .drop = FALSE) %>%
  summarise(Isolated = n()) %>%
  ungroup() %>%
  mutate(Isolated = Isolated) %>% 
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Isolated)

IE_spring_total <- IE %>%
  summarise(Isolated = n()) %>%
  ungroup() %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Isolated)

IE_all_total <- E_all %>%
  filter(!is.na(Isolated)) %>%
  #Don't count quarantines within 10 days of isolation, and change End Dates 
  select(Last_Name:First_Name, Isolated, End_Date)%>%
  summarise(Isolated = n()) %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Isolated)

IE_Tab <- bind_rows(IE_yest, IE_spring_total, IE_all_total)

#Maximum count needed for graphs
mIE <- IE_days_fill %>%
  group_by(Date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

#########################################################################
#Employee Cases

#Fill in dates between start of student quarantine and end date,
#Then total for each day
CE <- E_spring %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Result Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  filter(Test_Date <= yest) %>%
  select(Last_Name:First_Name, Test_Date, End_Date)

CE_days_fill <- CE %>%
  rowwise() %>%
  do(data.frame(.[1:2], Test_Date = seq(.$Test_Date, .$End_Date, by = "1 day"))) %>%
  tibble()

CE_yest <- CE_days_fill %>%
  #The line below is to create bogus data so that the summarization works
  add_row(Last_Name = NA, First_Name = NA, Test_Date = yest) %>%
  filter(Test_Date == yest) %>%
  group_by(Test_Date, .drop = FALSE) %>%
  summarise(Cases = n()) %>%
  ungroup() %>%
  mutate(Cases = Cases-1) %>% #Correct for the bogus data
  mutate(Type = str_glue("Active on ", format(yest, "%a %b %d"))) %>%
  select(Type, Cases)

CE_spring_total <- CE %>%
  summarise(Cases = n()) %>%
  mutate(Type = "Spring Semester Total") %>%
  select(Type, Cases)

CE_all_total <- E_all %>%
  filter(Test_Result == "p") %>%
  #Fill in missing Test Dates 
  mutate(Test_Date = case_when(
    !is.na(Test_Date) ~ Test_Date,
    !is.na(Result_Date) ~ Result_Date,
    !is.na(Isolated) ~ Isolated,
    !is.na(Quarantine) ~ Quarantine,
    TRUE ~ yest - 1  #No data defaults to 2 days ago
  )) %>%
  select(Last_Name:First_Name, Test_Date, End_Date)%>%
  summarise(Cases = n()) %>%
  mutate(Type = "20-21 Academic Year Total") %>%
  select(Type, Cases)

CE_Tab <- bind_rows(CE_yest, CE_spring_total, CE_all_total)

#Maximum count needed for graphs
mCE <- CE_days_fill %>%
  group_by(Test_Date, .drop = FALSE) %>%
  summarise(n = n()) %>%
  slice(which.max(n)) %>%
  .$n

#########################################################################
#Testing Data

#Join with other testing data
#T2 <-SS %>%
#  select(id, test_result, test_date) %>%
#  drop_na() %>%
#  mutate(at_health_center = TRUE) %>% Currently the At_Health_Center data is ambiguous
#  full_join(x = T, y = ., by = c("id", "test_date", "test_result"))%>%
#  mutate(at_health_center = case_when(
#    is.na(at_health_center.x) ~ at_health_center.y,
#    TRUE ~ at_health_center.x
#  )) %>%
#  select(-at_health_center) %>%
#  filter(test_date <= yest) %>%
#  mutate(test_result = (test_result == "p")) %>%
#  select(-at_health_center.x, -at_health_center.y) %>%

#Positives are tested again, so we group by id and date, then use prod()
T2 <- T %>%
  mutate(test_date = as_date(test_time)) %>%
  group_by(id, test_date, employee) %>%
  summarise(test_result = prod(test_result)) %>%
  mutate(test_result = case_when(
    id == 1610566 ~ 0,    #Fix data entry error
    TRUE ~ test_result
  ))
  

#Weekly  
TW <- T2 %>%
  group_by(employee) %>%
  summarise(Cases = sum(test_result), Total = n()) %>%
  mutate(Type = c("Students: Spring Semester", "Employees: Spring Semesester"),
         Percent = percent(case_when(
           Total == 0 ~ 0,
           TRUE ~ Cases/Total
         ), accuracy = 0.1)) %>%
  select(Type, Total, Cases, Percent)

#Past Week ALl Weekly
PTW <- T2 %>%
  filter(test_date > yest - 7) %>%
  group_by(employee) %>%
  summarise(Cases = sum(test_result), Total = n()) %>%
  mutate(Type = c("Students: Past Week", "Employees: Past Week"),
         Percent = percent(case_when(
           Total == 0 ~ 0,
           TRUE ~ Cases/Total
         ), accuracy = 0.1)) %>%
  select(Type, Total, Cases, Percent)

T_Tab <- bind_rows(PTW, TW)

T_Pos <- T2 %>%
  group_by(test_date, employee) %>%
  summarise(Cases = sum(test_result), Total = n())

T_Pos_W <- T_Pos%>%
  group_by(employee) %>%
  complete(test_date = seq.Date(as.Date("2021-01-15"), yest, by = "day"),
           fill = list(Cases = 0, Total = 0))%>%
  mutate(Cases = roll_sumr(Cases, 7, fill = NA),
         Total = roll_sumr(Total, 7, fill = NA)) %>%
  drop_na() %>%
  mutate(Percent = case_when(
           Total == 0 ~ 0,
           TRUE ~ Cases/Total
         ))

#Colors used for graphs
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
c_vals = gg_color_hue(4)
names(c_vals) <- rev(levels(SS$location))

c_vals2 = gg_color_hue(2)
names(c_vals2) <- c("Positive", "Negative")
```

![Grace Logo](Logo-GC-Red-Background-Stretched.jpg)\

<center>
# Grace College Internal COVID-19 Data
## Compiled by Dr. Ryan Johnson using contact tracing data from Laura Green and Nicole Gibson, as well as testing data from the state of Indiana.
### Last updated `r format(Sys.time(), '%A, %B %d, %Y, at %I:%M%p')`
</center>

\vspace{2 in}

Notes and Irregularities:


  - (1/28) Students who tested positive before coming to Grace are labeled as `Before` and are not included in total numbers.
  - (1/27) The reported total quarantines are currently not counting 13 quarantines from last fall that turned into isolations when those students showed symptoms.  This way, one can report the sum of our quarantines and isolations without double counting any stuedents.
  - (1/27) Quarantines from international travel are no longer counted among `Total` or graphed.
  - (1/26) The positivity rate was changed to only show the positivity rate of the weekly tests at Grace.

\newpage

# Cases


### Confirmed Cases Among Students

Grace College required students to test negative before arriving on campus, and those that tested positive before coming are listed in the column `Before`.  These are not counted in our total, since they never set foot on campus.

```{r student_cases_table}
CS_Tab %>%
  select(Type, Total, Home, Grace, Before)%>%
  kbl(caption = "Student Cases", booktabs = TRUE, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```



```{r student_cases_vis, fig.height = 4}
adjust = 1
SS_days_fill %>%
  filter(test_result == "p", location != "Before") %>%
  ggplot(aes(x = date, fill = location)) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    scale_fill_manual(values = c_vals) +
    # Make this as high as the tallest column
    coord_fixed(ratio = max(mCS,5)) +
    ggtitle("Active Confirmed Cases Among Students Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15),
          legend.position="bottom") + 
    ylab("Students") + 
    xlab("Date")+
    geom_hline(yintercept =  seq(0, mCS+1, 10)/mCS, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))
#+
#    annotate("text", x = spring+2,
#             y = seq(11, mCS, 10)/mCS, label = seq(10, mCS, 10))
```

### Confirmed Cases Among Employees

```{r employee_cases_table}
CE_Tab %>%
  kable(caption = "Employee Cases",
        booktabs = TRUE,
        format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```

```{r employee_cases_vis}
adjust = 1
CE_days_fill %>%
  ggplot(aes(x = Test_Date, fill = "red")) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    # Make this as high as the tallest column
    coord_fixed(ratio = max(mCE,5)) +
    ggtitle("Active Confirmed Cases Among Employees Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Employees") + 
    xlab("Date") +
    theme(legend.position = "none")+
    geom_hline(yintercept =  seq(0, mCE, 10)/mCE, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))#+
#    annotate("text", x = spring+2,
#             y = seq(11, mCE, 10)/cf, label = seq(10, mCE, 10))
```

\newpage

The number of cases below is less than the number of cases on the last page because it does not include students who tested positive before arriving on campus, of which there are 2.

# Student Testing

```{r testing_table}
T_Tab %>%
  kbl(caption = "Student Testing",
      booktabs = TRUE, format = "latex",
      col.names = c("Type", "Tests", "Cases", "Percent Postive"),
      align = c('l','r', 'r','r')) %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```

```{r student_testing_percent, fig.height=3}
T_Pos_W %>%
  filter(employee == FALSE) %>%
  ggplot(aes(x = test_date, y = Percent)) +
  geom_point(size = 3)+
  geom_line(size = 0.5, color = "blue", linetype = "dashed") +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(spring, last))+ 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1),
                     limit=c(0,.02))+
  ggtitle("Student Testing - 7 Day Rolling Average") + 
    theme(plot.title = element_text(hjust = 0.5, size = 20),
          legend.text = element_text(size = 15),
          legend.position="bottom") + 
  ylab("Percent Positive") + 
  xlab("Date")+
  geom_vline(xintercept =  seq(spring, last, by = "months")) +
  geom_hline(yintercept = 0) +
  scale_color_manual(values = c_vals2)
```

```{r student_testing, fig.height=6}
T_Pos %>%
  filter(employee == FALSE) %>%
  mutate(Negative = Total - Cases) %>%
  rename(Positive = Cases) %>%
  select(-Total) %>%
  group_by(test_date) %>%
  pivot_longer(cols = c(Positive, Negative),
               names_to = "Test_Result",
               values_to = "Count") %>%
  mutate(Test_Result = factor(Test_Result, levels = c("Positive", "Negative"))) %>%
  ggplot(aes(x = test_date, y = Count, fill = Test_Result)) +
  geom_histogram(stat = "identity", position = "stack")+
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(spring, last),
               sec.axis = dup_axis())+ 
  scale_y_continuous(limit=c(0,NA))+ #Change the 200 to NA in the future
  ggtitle("Student Testing - Tests Given") + 
    theme(plot.title = element_text(hjust = 0.5, size = 20),
          legend.text = element_text(size = 15),
          legend.position="bottom") + 
  ylab("Number of Tests") + 
  xlab("Date")+
  geom_vline(xintercept =  seq(spring, last, by = "months")) +
  geom_hline(yintercept = 0) +
  scale_fill_manual(values = c_vals2)
```

```{r employee_testing_percent, fig.height=2, eval = FALSE}
T_Pos_W %>%
  filter(employee == TRUE) %>%
  ggplot(aes(x = test_date, y = Percent)) +
  geom_point(size = 3)+
  geom_line(size = 0.5, color = "blue", linetype = "dashed") +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(spring, last))+ 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1),
                     limit=c(0,.02))+
  ggtitle("Employee Testing - 7 Day Rolling Average") + 
    theme(plot.title = element_text(hjust = 0.5, size = 20),
          legend.text = element_text(size = 15),
          legend.position="none") + 
  ylab("Percent Positive") + 
  xlab("Date")+
  geom_vline(xintercept =  seq(spring, last, by = "months")) +
  geom_hline(yintercept = 0) +
  scale_color_manual(values = c_vals2)
```

```{r employee_testing, fig.height=2}
T_Pos %>%
  filter(employee == TRUE) %>%
  mutate(Negative = Total - Cases) %>%
  rename(Positive = Cases) %>%
  select(-Total) %>%
  group_by(test_date) %>%
  pivot_longer(cols = c(Positive, Negative),
               names_to = "Test_Result",
               values_to = "Count") %>%
  mutate(Test_Result = factor(Test_Result, levels = c("Positive", "Negative"))) %>%
  ggplot(aes(x = test_date, y = Count, fill = Test_Result)) +
  geom_histogram(stat = "identity", position = "stack")+
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(spring, last),
               sec.axis = dup_axis())+ 
  scale_y_continuous(limit=c(0,NA))+ #Change the 200 to NA in the future
  ggtitle("Employee Testing - Tests Given") + 
    theme(plot.title = element_text(hjust = 0.5, size = 20),
          legend.text = element_text(size = 15),
          legend.position="none") + 
  ylab("Number of Tests") + 
  xlab("Date")+
  geom_vline(xintercept =  seq(spring, last, by = "months")) +
  geom_hline(yintercept = 0) +
  scale_fill_manual(values = c_vals2)
```

\newpage

# Isolated

Grace College required students to test negative before arriving on campus, and those that tested positive before coming are listed in the column `Before`.  These are not counted in our total, since they never set foot on campus.

### Isolated Students

```{r studend_isolations_table}
IS_Tab %>%
  select(Type, Total, Home, Grace, Before)%>%
  kbl(caption = "Student Isolations",
        booktabs = TRUE, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```


```{r student_isolations_vis, fig.height = 4}
adjust = 1
cf = max(mIS+2, 5)
SS_days_fill %>%
  filter(type == "Isolation", location != "Before") %>%
  ggplot(aes(x = date, fill = location)) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1,
                 stackratio = 1) + #was adjust
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    scale_fill_manual(values = c_vals) +
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Isolated Students Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15),
          legend.position="bottom") + 
    ylab("Students") + 
    xlab("Date")+
    geom_vline(xintercept =  seq(spring, last, "months"))+
    geom_hline(yintercept =  seq(0, mIS+1, 10)/cf, linetype = "dotted")
#+
#    annotate("text", x = spring+2,
#             y = seq(11, mIS, 10)/cf, label = seq(10, mIS, 10))
```

### Isolated Employees

```{r, employee_isolations_table}
IE_Tab %>%
  kable(caption = "Employee Isolations",
        booktabs = TRUE, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```

```{r employee_isolations_vis}
cf = max(mIE+2, 5)
IE_days_fill %>%
  ggplot(aes(x = Date, fill = "red")) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Isolated Employees Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Employees") + 
    xlab("Date") +
    theme(legend.position = "none") +
    geom_hline(yintercept =  seq(0, mIE, 10)/cf, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))#+
#    annotate("text", x = spring+2,
#             y = seq(11, mIE, 10)/cf, label = seq(10, mIE, 10))
```

\newpage

# Quarantined

### Quarantined Students

In the table below, `Grace_travel` are quarentines from international travel, and are not counted among the category `Grace` or the category `Total`.  Neither are they graphed below.  This is because these quarantines are from international travel, not exposure to COVID-19.

```{r student_quarantines_table}
QS_Tab %>%
  select(Type, Total, Home, Grace, Grace_travel) %>%
  kable(caption = "Student Quarantines",
        booktabs = TRUE, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```



```{r student_quarantines_vis, fig.height=4}
adjust = 1
cf = max(mQS, 5)
SS_days_fill %>%
  filter(type == "Quarantine", location != "Grace_travel") %>%
  ggplot(aes(x = date, fill = location)) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  ="7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    scale_fill_manual(values = c_vals) +
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Quarantined Students Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15),
          legend.position="bottom") + 
    ylab("Students") + 
    xlab("Date") +
    geom_hline(yintercept =  seq(0, mQS, 10)/cf, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))+
    annotate("text", x = spring+2,
             y = (1+seq(10, mQS, 10))/cf, label = seq(10, mQS, 10))
```

### Quarantined Employees

```{r employee_quarantines_table}
QE_Tab %>%
  kable(caption = "Employee Quarantines",
        booktabs = TRUE, format = "latex") %>%
  kable_styling(latex_options = "striped")%>%
  kable_styling(latex_options = "hold_position")
```

```{r employee_quarantines_vis}
adjust = 1
cf = max(mQE+2, 5)
QE_days_fill %>%
  ggplot(aes(x = Date, fill = "red")) + 
    geom_dotplot(method = "histodot",
                 binwidth = 1,
                 stackgroups = TRUE,
                 dotsize = 1,
                 stackratio = adjust) +
    scale_x_date(date_labels="%b %d",
                 date_breaks  = "7 days",
                 minor_breaks = "1 day",
                 limits = c(spring, last)) +
    scale_y_continuous(NULL, breaks = NULL) + 
    # Make this as high as the tallest column
    coord_fixed(ratio = cf) +
    ggtitle("Active Quarantined Employees Each Day") + 
    theme(plot.title = element_text(hjust = 0.5),
          legend.text = element_text(size = 15)) + 
    ylab("Employees") + 
    xlab("Date") +
    theme(legend.position = "none") +
    geom_hline(yintercept =  seq(0, mQE, 10)/cf, linetype = "dotted")+
    geom_vline(xintercept =  seq(spring, last, "months"))#+
 #   annotate("text", x = first,
 #            y = seq(1, mQE+1, 10)/cf, label = seq(0, mQE, 10))
```


\newpage


```{r state_and_county, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
#Input parameters
cfirst = floor_date(yest-90, unit = "month")
clast = ceiling_date(yest, unit = "month")

K$CC7 <- c(rep(0,6), rollmean(K$COVID_COUNT, 7))
K$CT7 <- c(rep(0,6), rollmean(K$COVID_TESTS_ADMINISTRATED, 7))
K$CCT <- c(rep(0,4), rollsum(K$COVID_COUNT, 7), rep(0,2))
K$CTT <- c(rep(0,6), rollsum(K$COVID_TESTS_ADMINISTRATED, 7))

nK2 = nrow(K)
K$TEST_RATE <- K$CCT / K$CTT
K$TEST_RATE <- c(rep(NA, 3), K$TEST_RATE[seq(-nK2, length.out = 3)])

K <- subset(K, DATE > cfirst)
nK = nrow(K)

I$CC7 <- c(rep(0,6), rollmean(I$COVID_COUNT, 7))
I$CT7 <- c(rep(0,6), rollmean(I$COVID_TEST, 7))
I$CCT <- c(rep(0,4), rollsum(I$COVID_COUNT, 7), c(rep(0,2)))
I$CTT <- c(rep(0,6), rollsum(I$COVID_TEST, 7))

nI2 = nrow(I)
I$TEST_RATE <- I$CC7 / I$CT7
I$TEST_RATE <- c(rep(NA, 3), I$TEST_RATE[seq(-nI2, length.out = 3)])

I <- subset(I, DATE > cfirst)
nI = nrow(I)

weekspan <- 3*7/(as.numeric(clast) - as.numeric(cfirst)+2)
```

\newpage

# Kosciusko County
Kosciusko County has had

* `r K$COVID_COUNT_MOVING_AVG[[nK]]` cases per day the past week.
* `r sum(K$COVID_COUNT)` total confirmed cases.

### Cases - Kosciusko

```{r K_cases, fig.height=5}
ggplot(K, aes(x = DATE, y = COVID_COUNT)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle("Kosciusko New Confirmed Cases") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("New Cases") + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(cfirst, clast, "months"))
```

### Positivity - Kosciusko

Kosciusko County has had `r subset(K, DATE == yest - 7)$POSITIVE_TEST_RATE_MOVING_AVG`% 7-day positivity rate for unique indiviudals as of `r format(yest-7, "%B %d")`.



```{r K_pos, fig.height=5}
ggplot(subset(K, DATE < yest - 6), aes(x = DATE, y = POSITIVE_TEST_RATE_MOVING_AVG/100)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     limit=c(0,NA)) +
  ggtitle("Kosciusko Percentage of Positive Tests - 7 Day Rolling Average") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  geom_vline(xintercept =  seq(cfirst, clast, "months")) +
  geom_hline(yintercept = 0)
#* `r round(100 * K$TEST_RATE[[nK-5]], digits = 1)`% 7-day positivity rate as of `r format(yest-5, "%B %d")`.  This number is computed assuming an average 2-day wait for test results, and might not fit exactly with the positivity rate on the state's dashboard.
#* `r round(100 * K$TEST_RATE[[nK-5]], digits = 1)`% = `r K$CCT[[nK-8]]` / `r K$CTT[[nK-8]]`.
```

\newpage

# Indiana

The total case numbers below are multiplied by $\frac{\text{Kos pop}}{\text{Ind pop}} = \frac{79456}{6732000} = 0.01180273$, so that it is easier to compare Kosciusko numbers to the average Indiana county.

Indiana has had

* `r round(I$CC7[[nI]], digits = 1)` cases per day the past week (normalized `r round(I$CC7[[nI]]*79456/6732000, digits = 1)`).
* `r prettyNum(sum(I$COVID_COUNT),big.mark=",",scientific=FALSE)` total confirmed cases (normalized `r round(sum(I$COVID_COUNT)*79456/6732000, digits = 1)`).

### Cases - Indiana

```{r I_cases, fig.height=5}
ggplot(I, aes(x = DATE, y = COVID_COUNT * 79456/6732000)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(limit=c(0,NA), oob = squish) +
  ggtitle("Normalized Indiana New Confirmed Cases") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Normalized New Cases") + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(cfirst, clast, "months"))
```

### Positivity - Indiana

Indiana reports a `r round(subset(I, DATE == yest - 7)$POSITIVITY_RATE_ALL_TESTS, 1)`% 7-day positivity rate for all tests as of `r format(yest-7, "%B %d")`.

```{r I_pos, fig.height=5}
ggplot(subset(I, DATE <= yest - 7), aes(x = DATE, y = POSITIVITY_RATE_ALL_TESTS/100)) + 
  geom_point(size = 4) +
  scale_x_date(date_labels="%b %d",
               date_breaks  = "7 days",
               minor_breaks = "1 day",
               limits = c(cfirst, clast)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     limit=c(0,NA)) +
  ggtitle("Indiana Average Positivity Rate for All Tests") + 
  theme(plot.title = element_text(size= 20, hjust = 0.5),
        legend.text = element_text(size = 15)) + 
  ylab("Percent Positive") + 
  xlab("Date") +
  stat_smooth(size = 1, se = FALSE, linetype = "dashed", span = 5/3*weekspan) +
  geom_vline(xintercept =  seq(cfirst, clast, "months"))

#* `r round(100 * I$TEST_RATE[[nI-5]], digits = 1)`% 7-day positivity rate as of `r format(yest-6, "%B %d")`.  This number is computed assuming an average 2-day wait for test results, and might not fit exactly with the positivity rate on the state's dashboard.
#* `r round(100 * I$TEST_RATE[[nI-5]], digits = 1)`% = `r prettyNum(I$CCT[[nI-8]],big.mark=",",scientific=FALSE)` / `r prettyNum(I$CTT[[nI-8]], ,big.mark=",",scientific=FALSE)`.
```

\newpage

# Indiana Map

The map below displays the cases per 100,000 per day averaged over the past week and the positivity rate for unique individuals averaged over the previous week.  The coloring scheme is relative, it colors the best county white and the worst county red.

```{r I_map, fig.width=12, fig.height=14}
lat_and_long <- read_excel("lat_and_long.xlsx")
lat_and_long$COUNTY_NUMERIC <- lat_and_long$COUNTY_NUMERIC + 18000
load("county_populations.RData")
county_data <- merge(x = pops, y = lat_and_long,
                     by.x = "key_numeric",
                     by.y = "COUNTY_NUMERIC")


counties_yest <- IN_counties[IN_counties$DATE == yest-7,]
counties_yest$COVID_COUNT_MOVING_AVG <- IN_counties[IN_counties$DATE == yest-1,]$COVID_COUNT_MOVING_AVG

Indices <- merge(x = counties_yest, y = county_data,
                 by.x = "LOCATION_ID",
                 by.y = "key_numeric")
Indices$Case_per <- Indices$COVID_COUNT_MOVING_AVG / Indices$population * 1000
Indices$case_index <- Indices$Case_per/sum(Indices$Case_per)
Indices$positivity_index <- Indices$POSITIVE_TEST_RATE_MOVING_AVG/sum(Indices$POSITIVE_TEST_RATE_MOVING_AVG)
Indices$combined <- sqrt(Indices$case_index * Indices$positivity_index)
Indices$dashboard <- Indices$Case_per/2 + Indices$POSITIVE_TEST_RATE_MOVING_AVG/10
Indices <- Indices[order(-Indices$combined),]
outbreaks <- Indices$county[1:6]

Indices$fips <- Indices$LOCATION_ID

Ind_trans <- subset(Indices, select = c(PRIM_LONG_DEC,
                                        PRIM_LAT_DEC,
                                        LOCATION_ID,
                                        COUNTY_NAME.x,
                                        combined,
                                        Case_per,
                                        POSITIVE_TEST_RATE_MOVING_AVG))
Ind_trans$labels <- paste0(Ind_trans$COUNTY_NAME.x, "\n",
                           round(100*Ind_trans$Case_per,0), " & ",
                           round(Ind_trans$POSITIVE_TEST_RATE_MOVING_AVG,0), "%")
Ind_map <- usmap_transform(Ind_trans)

plot_usmap("counties",
           data = Indices, values = "combined", color = "blue",
           include = Indices$fips, labels = FALSE) + 
    ggplot2::scale_fill_continuous(low = "white", high = "red") + 
    theme(legend.position = "none") +
    geom_text(data = Ind_map,
              aes(x = PRIM_LONG_DEC.1,
                  y = PRIM_LAT_DEC.1,
                  label = labels))
```

